"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}angular.module("starter",["ionic","ngMap","ngFileUpload","starter.controllers","report.controllers","controller.settings","rainapp-constants","ngIOS9UIWebViewPatch","controller.signup","controller.login","controller.map","controller.register","controller.map-detail","controller.village-detail","service.authentication","service.login","service.signup","service.user","service.api","rainapp.utils","AdalAngular"]).run(function($ionicPlatform,$rootScope,$ionicLoading,$location,$http,$localstorage){$ionicPlatform.ready(function(){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard){cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0);var codePushCallback=function(syncStatus){switch(syncStatus){case SyncStatus.APPLY_SUCCESS:case SyncStatus.UP_TO_DATE:case SyncStatus.UPDATE_IGNORED:break;case SyncStatus.ERROR:console.log("codesync error")}},options={installMode:InstallMode.ON_NEXT_RESTART,updateDialog:!0};window.codePush.sync(codePushCallback,options)}}),$rootScope.globals=$localstorage.getObject("globals"),$rootScope.globals||($rootScope.globals={}),$rootScope.$on("loading:show",function(){$ionicLoading.show({template:"<ion-spinner></ion-spinner>"})}),$rootScope.$on("loading:show-slow",function(){$ionicLoading.show({template:"Please wait, this may take up to 10 minutes</br><ion-spinner></ion-spinner>"})}),$rootScope.$on("loading:hide",function(){$ionicLoading.hide()})}).config(["$compileProvider","$stateProvider","$urlRouterProvider","$httpProvider","adalAuthenticationServiceProvider",function($compileProvider,$stateProvider,$urlRouterProvider,$httpProvider,adalProvider){adalProvider.init({instance:"https://login.microsoftonline.com/",tenant:"35a32751-a7a4-47e9-830e-d320e5e2ce25",clientId:"18841449-2afd-4fdb-9246-0f7e461c61f8",extraQueryParameter:"nux=1"},$httpProvider)}]).config(function($stateProvider,$urlRouterProvider,$provide,debug,adalAuthenticationServiceProvider){$stateProvider.state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginController"}).state("signup",{url:"/signup",templateUrl:"templates/signup.html",controller:"SignupController"}).state("tab",{url:"/tab",abstract:!0,templateUrl:"templates/tabs.html"}).state("tab.map",{url:"/map",views:{"tab-map":{templateUrl:"templates/tab-map.html",controller:"MapCtrl"}}}).state("tab.map-detail",{url:"/map/:postcode/:resourceId",views:{"tab-map":{templateUrl:"templates/map-detail.html",controller:"MapDetailController"}}}).state("tab.village-detail",{url:"/map/:postcode/village/:villageId",views:{"tab-map":{templateUrl:"templates/village-detail.html",controller:"VillageDetailController"}}}).state("tab.report",{url:"/report",views:{"tab-report":{templateUrl:"templates/tab-report.html",controller:"ReportController"}}}).state("tab.chat-detail",{url:"/chats/:chatId",views:{"tab-chats":{templateUrl:"templates/chat-detail.html",controller:"ChatDetailCtrl"}}}).state("tab.settings",{url:"/settings",views:{"tab-settings":{templateUrl:"templates/tab-settings.html",controller:"SettingsController"}}}).state("tab.settings-register",{url:"/settings/register",views:{"tab-settings":{templateUrl:"templates/register.html",controller:"RegisterController"}}}),$urlRouterProvider.otherwise("/tab/map"),$provide.decorator("$exceptionHandler",["$delegate",function($delegate){return function(exception,cause){$delegate(exception,cause);var data={type:"angular",url:window.location.hash,localtime:Date.now()};cause&&(data.cause=cause),exception&&(exception.message&&(data.message=exception.message),exception.name&&(data.name=exception.name),exception.stack&&(data.stack=exception.stack)),1==debug?(console.log("exception",data),window.alert("Error: "+data.message)):track("exception",data)}}]),window.onerror=function(message,url,line,col,error){var stopPropagation=!debug,data={type:"javascript",url:window.location.hash,localtime:Date.now()};return message&&(data.message=message),url&&(data.fileName=url),line&&(data.lineNumber=line),col&&(data.columnNumber=col),error&&(error.name&&(data.name=error.name),error.stack&&(data.stack=error.stack)),1==debug?(console.log("exception",data),window.alert("Error: "+data.message)):track("exception",data),stopPropagation}}),angular.isNullOrUndefined=function(val){return angular.isUndefined(val)||null===val},angular.module("rainapp-constants",[]).constant("apiUrl","https://mywell-server.marvi.org.in").constant("debug","1").constant("version_number","1.3.1"),angular.module("rainapp.utils",[]).factory("$localstorage",["$window",function($window){return{set:function(key,value){$window.localStorage[key]=value},get:function(key,defaultValue){return $window.localStorage[key]||defaultValue},setObject:function(key,value){$window.localStorage[key]=JSON.stringify(value)},getObject:function(key){try{return JSON.parse($window.localStorage[key])}catch(err){return null}},delete:function(key){$window.localStorage.removeItem(key)}}}]).constant("AzureMobileServiceClient",{API_URL:"https://watermanagementmobile.azure-mobile.net/",API_KEY:"vQWzbtVFXjBmcfKYtVmYPVkCzjynlo72"}).service("CachingService",function($localstorage){function getReportCache(){return findOrCreateReportCache()}function getReportAtIndex(index){return getReportCache()[index]}function deleteReportAtIndex(index){var reportCache=findOrCreateReportCache();return reportCache.splice(index,1),saveReportCache(reportCache)}function addReportToCache(report){var reportCache=findOrCreateReportCache();return reportCache.push(report),saveReportCache(reportCache)}function findOrCreateReportCache(){var reportCache=$localstorage.getObject("reportCache");return angular.isNullOrUndefined(reportCache)?(reportCache=[],saveReportCache(reportCache)):reportCache}function saveReportCache(reportCache){return $localstorage.setObject("reportCache",reportCache),reportCache}function addResourceToCache(data){$localstorage.setObject("resourceCache",data)}function getResourceFromCache(){var resourceCache=$localstorage.getObject("resourceCache");return angular.isNullOrUndefined(resourceCache)?{}:resourceCache}function saveFavouriteLocation(lat,lng){console.log("Saving favourite location:",lat,lng);var locationArray=[lat,lng];$localstorage.setObject("favouriteLocation",locationArray)}function getFavouriteLocation(){var location=$localstorage.getObject("favouriteLocation");return console.log("Getting favouriteLocation:",location),location}return{getReportCache:getReportCache,getReportAtIndex:getReportAtIndex,deleteReportAtIndex:deleteReportAtIndex,addReportToCache:addReportToCache,addResourceToCache:addResourceToCache,getResourceFromCache:getResourceFromCache,saveFavouriteLocation:saveFavouriteLocation,getFavouriteLocation:getFavouriteLocation}}),angular.module("starter.controllers",["ionic"]).controller("AppController",function($scope,$ionicModal,AuthenticationService,$state,$rootScope,LoginService,ApiService){var currentUser=$rootScope.globals.currentUser;$scope.isLoggedIn=!!currentUser,$scope.login=function(){$scope.modal.show()},$scope.logout=function(){AuthenticationService.ClearCredentials(),$rootScope.$broadcast("login-state-changed"),$scope.isVerified=!1,$scope.unverifiedUsers=[]},$scope.cancel=function(){$scope.modal.hide()},$scope.$on("login-state-changed",function(e){var currentUser=$rootScope.globals.currentUser;$scope.isLoggedIn=!!currentUser}),$scope.performLogin=function(form){angular.isNullOrUndefined(form)||angular.isNullOrUndefined(form.password)||0===form.password.length||ApiService.login("marvi",form.password).then(function(response){if(console.log(response),200===response.status){var user={id:response.data.userId,authToken:response.data.id,username:"marvi",verified:!0,service:"none"};AuthenticationService.SetCredentials(user,response.data.id),$scope.modal.hide()}else window.alert("Login Error: "+response.status)}).catch(function(err){console.log("err",err),window.alert("Login Error: "+err.status)})},$ionicModal.fromTemplateUrl("templates/login.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal}),$scope.$on("$destroy",function(){$scope.modal.remove()}),$scope.$on("modal.hidden",function(){$state.go($state.current,{},{reload:!0}),$rootScope.$broadcast("login-state-changed",{any:{}})}),$scope.$on("modal.removed",function(){})}),angular.module("controller.login",[]).controller("LoginController",function($scope,$location,AuthenticationService,$ionicPopup,debug,$http){$scope.user={},function(){AuthenticationService.ClearCredentials()}(),$scope.signup=function(){$location.path("/signup")}}),angular.module("controller.map",[]).controller("MapCtrl",function($scope,apiUrl,$state,$window,$ionicHistory,$ionicModal,$ionicPopup,ApiService,CachingService){function saftelyGetLevelString(value){return angular.isNullOrUndefined(value)?"":value.toFixed(2)}function getPopupContentForResource(resource){resource.postcode,resource.villageId;angular.isNullOrUndefined(resource.village)||(villageName=resource.village.name);var specificContent=null;switch(resource.type){case ResourceType.WELL:specificContent=getSpecificContentForWell(resource);break;case ResourceType.CHECKDAM:specificContent=getSpecificContentForCheckDam(resource);break;case ResourceType.RAINGAUGE:specificContent=getSpecificContentForRainGauge(resource)}return'<div style="line-height:1.35;overflow:hidden;white-space:nowrap;"> Village: '+$scope.getVillageName(resource.postcode,resource.villageId)+"\n      <br/>ResourceId : "+resource.id+"\n      "+specificContent+"\n      <br/><a href=#/tab/map/"+resource.postcode+"/"+resource.id+">More</a>"}var ResourceType={WELL:"well",RAINGAUGE:"raingauge",CHECKDAM:"checkdam"},wellIcon=L.icon({iconUrl:"img/ball.png",iconSize:[36,36],iconAnchor:[0,0],popupAnchor:[17,5]}),checkdamIcon=L.icon({iconUrl:"img/wall.png",iconSize:[36,36],iconAnchor:[-15,0],popupAnchor:[17,5]}),raingaugeIcon=L.icon({iconUrl:"img/raindrop.svg",iconSize:[36,56],iconAnchor:[0,0],popupAnchor:[17,5]});$scope.markers={},$scope.data=[],$scope.isPageActive=!0,$scope.closestVillage="Varni",$scope.searchResource="";var getMarkerIdForVillage=function(village){return village.postcode+"-"+village.id},getMarkerIdForResource=function(resource){return resource.postcode+"-"+resource.id},resetMap=function(){Object.keys($scope.markers).forEach(function(_key){var marker=$scope.markers[_key];if(!marker)return void console.log("no marker for key:",_key);leafletMap.removeLayer(marker)})},loadDataAndSetupMap=function(){ApiService.getVillages().then(function(villages){$scope.villages=villages,villages.forEach(function(village){var icon=L.divIcon({html:'            <div class="">                 <h2>'+village.name+"</h2>             </div>",className:"village-div-icon"}),marker=L.marker([village.coordinates.lat,village.coordinates.lng],{icon:icon}).addTo(leafletMap);$scope.markers[getMarkerIdForVillage(village)]=marker})}).then(function(){return ApiService.getResources()}).then(function(response){$scope.data=response.data.map(function(resource){return resource.villageName=$scope.getVillageName(resource.postcode,resource.villageId),resource}),$scope.data.forEach(function(resource){var percentageFull=((resource.well_depth-resource.last_value)/resource.well_depth*100).toFixed(2);resource.percentageFull=percentageFull;var icon=null;switch(resource.type){case ResourceType.WELL:icon=wellIcon;break;case ResourceType.CHECKDAM:icon=checkdamIcon;break;case ResourceType.RAINGAUGE:icon=raingaugeIcon;break;default:console.error("Unknown ResourceType: "+resource.type)}var marker=L.marker([resource.geo.lat,resource.geo.lng],{icon:icon}).addTo(leafletMap);marker.bindPopup(getPopupContentForResource(resource)),$scope.markers[getMarkerIdForResource(resource)]=marker})})},leafletMap=L.map("leafletMap",{zoomControl:!0,minZoom:5,maxZoom:18});L.tileLayer("https://api.mapbox.com/styles/v1/lewisdaly/ciuqhjyzo00242iphq3wo7bm4/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibGV3aXNkYWx5IiwiYSI6ImNpdXE3ajltaDAwMGYyb2tkdjk2emx3NGsifQ.wnqFweA7kdijEtsgjTJIPw").addTo(leafletMap),loadDataAndSetupMap();var firstLocation=function(){var savedResource=CachingService.getFavouriteLocation();return savedResource||(console.log("No first location!"),[24.593,74.198])}();leafletMap.setView(firstLocation,16),$scope.getVillageName=function(postcode,villageId){var village=$scope.villages.filter(function(village){return village.postcode===postcode&&village.id===villageId})[0];return village?village.name:(console.error("Village not found for postcode: "+postcode+" and villageId: "+villageId),"null")},$scope.searchItemPressed=function(event,resource){$scope.hideSearchResults(),document.getElementById("search-box-input").blur(),window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.close();var marker=$scope.markers[getMarkerIdForResource(resource)];leafletMap.panTo(new L.LatLng(resource.geo.lat,resource.geo.lng)),marker.openPopup()},$scope.locate=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(position){leafletMap.panTo(new L.LatLng(position.coords.latitude,position.coords.longitude))}):console.log("Geolocation is not supported by this browser.")},$scope.showSearchResults=function(){$scope.showSearchPanel=!0},$scope.hideSearchResults=function(){$scope.showSearchPanel=!1},$scope.watchSearch=function(search){return $scope.searchResource=search,search.length>2?$scope.showSearchResults():$scope.hideSearchResults()},$scope.refreshDataPressed=function(){resetMap(),loadDataAndSetupMap()};var getSpecificContentForWell=function(resource){return"\n    <br/>Depth to Water Table: "+saftelyGetLevelString(resource.last_value)+" m\n    "},getSpecificContentForCheckDam=function(resource){return"\n      <br/>Latest Reading: "+saftelyGetLevelString(resource.last_value)+" m\n      "},getSpecificContentForRainGauge=function(resource){return"\n      <br/>Latest Reading: "+saftelyGetLevelString(resource.last_value)+" mm\n      "}}),angular.module("controller.map-detail",["nvd3"]).controller("MapDetailController",function($scope,$state,$rootScope,ApiService,$stateParams,CachingService){function setupData(){return $rootScope.$broadcast("loading:show"),Promise.all([ApiService.getReadingsByWeek($stateParams.postcode,$scope.resourceId),ApiService.getDifferenceFromJune(null,"individual",$scope.resourceId,$stateParams.postcode).catch(function(err){return console.log(err)}),ApiService.getResource($stateParams.postcode,$scope.resourceId).then(function(response){return CachingService.saveFavouriteLocation(response.geo.lat,response.geo.lng),response}),ApiService.getCurrentVillageAverage($stateParams.postcode,$scope.resourceId)]).then(function(results){var readingsByWeek=results[0].data;allWeeklyReadings=readingsByWeek.readings,weeks=readingsByWeek.weeks;var juneData=null;if(!angular.isNullOrUndefined(results[1])&&!angular.isNullOrUndefined(results[1].data)){juneData={pastReadingDate:new Date(results[1].data.pastReadingDate).toISOString().slice(0,10),difference:results[1].data.difference.toFixed(2)+" m"}}var readingValue=null,percentageFull=null;if(!angular.isNullOrUndefined(results[2])){var reading=results[2];$scope.resource=reading,readingValue=reading.last_value.toFixed(2),percentageFull=((reading.well_depth-reading.last_value)/reading.well_depth*100).toFixed(0)}var villageAverageReading=null;angular.isNullOrUndefined(results[3])||angular.isNullOrUndefined(results[3].data)||(villageAverageReading=results[3].data.avgReading.value),angular.isNullOrUndefined(readingValue)&&angular.isNullOrUndefined(percentageFull)&&angular.isNullOrUndefined(villageAverageReading)&&angular.isNullOrUndefined(juneData)||($scope.stats={readingValue:readingValue,percentageFull:percentageFull,villageAverageReading:villageAverageReading,juneData:juneData});var slicePoints=[0,51,103,allWeeklyReadings.length];splitWeeklyReadings=[allWeeklyReadings.slice(slicePoints[2],slicePoints[3]),allWeeklyReadings.slice(slicePoints[1],slicePoints[2]),allWeeklyReadings.slice(slicePoints[0],slicePoints[1])],setupResourceType(),setupChart(),$scope.$apply(),$rootScope.$broadcast("loading:hide")}).catch(function(err){console.log("Error setting up data",err),$rootScope.$broadcast("loading:hide")})}$scope.$on("$ionicView.enter",function(e){}),$scope.resourceId=$stateParams.resourceId,$scope.stats=null;var detailChart=null,allWeeklyReadings=[],splitWeeklyReadings=[],weeks=[],graphLabel=null,shouldReverseGraph=null,setupResourceType=function(){switch($scope.resource.type){case"well":$scope.readableResourceType="Well",graphLabel="Depth to Water Level (m)",shouldReverseGraph=!0;break;case"raingauge":$scope.readableResourceType="Rainfall Station",graphLabel="Rainfall Amount (mm)",shouldReverseGraph=!1;break;case"checkdam":$scope.readableResourceType="Checkdam",graphLabel="Water Column Height (m)",shouldReverseGraph=!1}},getChartDataAndLabel=function(dataRange){var dataAndLabel={data:[],labels:null};switch(dataRange){case"month":dataAndLabel.data[0]=splitWeeklyReadings[0].slice(1).slice(-4),dataAndLabel.data[1]=splitWeeklyReadings[1].slice(1).slice(-4),dataAndLabel.data[2]=splitWeeklyReadings[2].slice(1).slice(-4),dataAndLabel.labels=weeks.slice(-4).map(function(dateTime){return moment(dateTime).format("DD-MMM")});break;case"3month":dataAndLabel.data[0]=splitWeeklyReadings[0].slice(1).slice(-12),dataAndLabel.data[1]=splitWeeklyReadings[1].slice(1).slice(-12),dataAndLabel.data[2]=splitWeeklyReadings[2].slice(1).slice(-12),dataAndLabel.labels=weeks.slice(-12).map(function(dateTime){return moment(dateTime).format("DD-MMM")});break;case"year":dataAndLabel.data[0]=splitWeeklyReadings[0].slice(1).slice(-52),dataAndLabel.data[1]=splitWeeklyReadings[1].slice(1).slice(-52),dataAndLabel.data[2]=splitWeeklyReadings[2].slice(1).slice(-52),dataAndLabel.labels=weeks.slice(-52).map(function(dateTime){return moment(dateTime).format("DD-MMM")});break;default:throw new Error("dataRange "+dataRange+" not found")}return dataAndLabel},setupChart=function(){var colors=[{border:"rgba(54, 162, 235, 1)",background:"rgba(54, 162, 235, 0.2)"},{border:"rgba(153, 102, 255, 1)",background:"rgba(153, 102, 255, 0.2)"},{border:"rgba(255, 159, 64, 1)",background:"rgba(255, 159, 64, 0.2)"}],chartData=getChartDataAndLabel("month"),ctx=document.getElementById("detailChart");detailChart=new Chart(ctx,{type:"line",data:{labels:chartData.labels,datasets:[{label:"This year",data:chartData.data[0],borderWidth:1,backgroundColor:colors[0].background,borderColor:colors[0].border,fill:"bottom"},{label:"Last Year",data:chartData.data[1],borderWidth:1,backgroundColor:colors[1].background,borderColor:colors[1].border,fill:"bottom"},{label:"2 years ago",data:chartData.data[2],borderWidth:1,backgroundColor:colors[2].background,borderColor:colors[2].border,fill:"bottom"}]},options:{title:{display:!0,text:graphLabel},spanGaps:!1,scales:{yAxes:[{ticks:{beginAtZero:!0,reverse:shouldReverseGraph}}]}}})};$scope.updateData=function(dataRange){var chartData=getChartDataAndLabel(dataRange);detailChart.data.datasets[0].data=chartData.data[0],detailChart.data.datasets[1].data=chartData.data[1],detailChart.data.datasets[2].data=chartData.data[2],detailChart.data.labels=chartData.labels,detailChart.update()},function(){setupData()}()}).filter("capitalize",function(){return function(input){return input?input.charAt(0).toUpperCase()+input.substr(1).toLowerCase():""}}),angular.module("controller.register",[]).controller("RegisterController",function($scope,$location,$rootScope,$ionicModal,$ionicPopup,ApiService,CachingService,apiUrl){var leafletMap=null;$scope.resources=["well","checkdam","raingauge"],$scope.refreshCoords=function(){if(!angular.isNullOrUndefined(leafletMap)){var center=leafletMap.getCenter();$scope.form.lat=null,$scope.form.lng=null,$scope.form.lat=center.lat,$scope.form.lng=center.lng}};!function(){$scope.form=CachingService.getResourceFromCache(),angular.isNullOrUndefined($scope.form.elevation)||($scope.form.max_wt_depth=$scope.form.elevation),angular.isNullOrUndefined($scope.form.geo)||($scope.form.lat=$scope.form.geo.lat,$scope.form.lng=$scope.form.geo.lng),angular.isNullOrUndefined(leafletMap)&&(leafletMap=L.map("leafletMapRegister",{zoomControl:!1,dragging:!0,doubleClickZoom:!1}).setView([24.593,74.198],17),L.tileLayer("https://api.mapbox.com/styles/v1/lewisdaly/ciuqhjyzo00242iphq3wo7bm4/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibGV3aXNkYWx5IiwiYSI6ImNpdXE3ajltaDAwMGYyb2tkdjk2emx3NGsifQ.wnqFweA7kdijEtsgjTJIPw").addTo(leafletMap))}(),$scope.locate=function(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(function(position){leafletMap.panTo(new L.LatLng(position.coords.latitude,position.coords.longitude)),$scope.form.lat=position.coords.latitude,$scope.form.lng=position.coords.longitude,$scope.$apply()},function(err){console.log(err);$ionicPopup.alert({title:"GeoLocation Error",template:err.message})});else{console.log("Geolocation is not supported by this browser.");$ionicPopup.alert({title:"GeoLocation Error",template:"Geolocation is not supported"})}};var checkAndUpdateMap=function(){angular.isNullOrUndefined($scope.form.lat)||angular.isNullOrUndefined($scope.form.lng)||$scope.form.lat.toString().length<5||$scope.form.lng.toString().length<4||leafletMap.panTo(new L.LatLng($scope.form.lat,$scope.form.lng))};$scope.$watch("form.lat",checkAndUpdateMap),$scope.$watch("form.lng",checkAndUpdateMap),$scope.submit=function(form){if(!1===form)return void $scope.modal.hide();var isFormValid=!0;if(null!=form&&null!=form.village_name&&""!==form.village_name.trim()&&null!=form.owner&&null!=form.postcode&&null!=form.type&&null!=form.lat&&null!=form.lng||(isFormValid=!1),"well"===form.type&&angular.isNullOrUndefined(form.max_wt_depth)&&(isFormValid=!1),isFormValid)if(form.id>9999||form.id<1e3){$ionicPopup.alert({title:"Error",template:"Id must be between 1000-9999"})}else{var data={geo:{lat:form.lat,lng:form.lng},owner:form.owner,village_name:form.village_name.trim(),mobile:"91"+form.mobile,email:form.email,well_depth:form.max_wt_depth,type:form.type,postcode:form.postcode,villageId:11,elevation:0};ApiService.registerWell(data).then(function(response){$ionicPopup.alert({title:"Thanks!",template:"Created a new "+form.type+" in "+form.village_name.trim()})}).catch(function(err){if(0===err.status)return displayMessage("Connection Error","Saving. Please try again later."),void CachingService.addResourceToCache(data);console.log("err",err);$ionicPopup.alert({title:"Error",template:err.statusText})})}else{$ionicPopup.alert({title:"Error",template:"Please fill out all the fields"})}}}),angular.module("report.controllers",[]).controller("ReportController",function($scope,$ionicPopup,$http,apiUrl,$rootScope,LoginService,ApiService,CachingService,Upload){function checkUserStatus(){$scope.isUserNotLoggedIn=!1,$scope.isUserNotVerified=!1,$scope.isUserLoggedInAndVerified=!1;var currentUser=$rootScope.globals.currentUser;currentUser?0==currentUser.verified?$scope.isUserNotVerified=!0:$scope.isUserLoggedInAndVerified=!0:$scope.isUserNotLoggedIn=!0}function displayMessage(title,message){$ionicPopup.alert({title:title,template:message})}function resetForm(){$scope.form={},$scope.form.date=new Date}resetForm(),$scope.$on("$ionicView.enter",function(e){checkUserStatus(),$scope.cachedReports=CachingService.getReportCache()}),$scope.$on("login-state-changed",function(e){checkUserStatus()}),$scope.refreshUser=function(){LoginService.reAuthenticateUser().then(function(response){var currentUser=$rootScope.globals.currentUser;console.log("currentUser: "+JSON.stringify(currentUser)),checkUserStatus()},function(error){})};var readingTypes={well:{id:"well",name:"Well",valuePlaceholder:"Depth to Water Level (m)"},raingauge:{id:"raingauge",name:"Rainfall",valuePlaceholder:"Rainfall amount (mm)"},checkdam:{id:"checkdam",name:"Checkdam",valuePlaceholder:"Water Column Height (m)"}};$scope.readingType=readingTypes.well,$scope.setReadingType=function(readingType){$scope.readingType=readingTypes[readingType]},$scope.sendReport=function(form){if(null==$scope.form.postcode||null==$scope.form.postcode||null==$scope.form.postcode||null==$scope.form.postcode){console.log("Fill out the form!");$ionicPopup.alert({title:"Error",template:"Please fill out all the fields"})}else!function(){var data={postcode:$scope.form.postcode,value:$scope.form.value,resourceId:$scope.form.resourceId,villageId:(""+$scope.form.resourceId).substring(0,2),date:$scope.form.date};ApiService.updateReading(data).then(function(response){displayMessage("Thanks!","Submitted successfully."),resetForm()}).catch(function(err){0===err.status?(displayMessage("Connection Error","Saving for later submission."),CachingService.addReportToCache(data),$scope.cachedReports=CachingService.getReportCache(),resetForm()):(console.log("Error: ",err),displayMessage("Error",err.data.error.message))})}()},$scope.submit=function(index){var report=CachingService.getReportAtIndex(index);ApiService.updateReading(report).then(function(response){console.log("Submitted successfully",response),displayMessage("Thanks!","Submitted successfully."),CachingService.deleteReportAtIndex(index),$scope.cachedReports=CachingService.getReportCache()}).catch(function(err){0===err.status?displayMessage("Connection Error","Still having trouble connecting. Please try again later."):(console.log("Error: ",err),displayMessage("Error",err.data.error.message))})},$scope.delete=function(index){CachingService.deleteReportAtIndex(index),$scope.cachedReports=CachingService.getReportCache()},$scope.upload=function(file){$rootScope.$broadcast("loading:show"),Upload.upload({url:apiUrl+"/api/containers/container1/upload",data:{file:file}}).then(function(resp){return console.log("Success "+resp.config.data.file.name+"uploaded. Response: "+resp.data),Promise.resolve(resp.data.result.files.file[0])},function(resp){throw console.log("Error status: "+resp.status),new Error(resp)},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);console.log("progress: "+progressPercentage+"% "+evt.config.data.file.name)}).then(function(fileResponse){return ApiService.processExcelFile(fileResponse)}).then(function(res){console.log(res),displayMessage("Done","Saved "+res.data.created+" readings, with "+res.data.warnings.length+" warnings")}).catch(function(err){if(console.error("error",err),500===err.status)return displayMessage("Error","Could not process file. Please ensure the format is correct.");displayMessage("Error",err.statusText)})},$scope.clearFile=function(){$scope.file=null},$scope.submitFile=function(){$scope.form.file.$valid&&$scope.file&&$scope.upload($scope.file)}}),angular.module("controller.settings",[]).controller("SettingsController",function($scope,AuthenticationService,$location,$rootScope,$ionicModal,$ionicPopup,ApiService,CachingService,apiUrl,version_number){function checkUserStatus(){$scope.unverifiedUsers=[],$scope.isUserNotLoggedIn=!1,$scope.isUserNotVerified=!1,$scope.isUserLoggedInAndVerified=!1,$scope.isVerified=!1;var currentUser=$rootScope.globals.currentUser;currentUser?0==currentUser.verified?$scope.isUserNotVerified=!0:($scope.isUserLoggedInAndVerified=!0,$scope.isVerified=!0):$scope.isUserNotLoggedIn=!0}$scope.version_number=version_number,$scope.templateUrl=apiUrl+"/containers/container1/download/template",$scope.apiBaseUrl=apiUrl,$scope.imageResourceId=null,$scope.isDesktop=angular.isNullOrUndefined(window.cordova),$scope.$on("$ionicView.enter",function(e){checkUserStatus()}),$scope.$on("login-state-changed",function(e){checkUserStatus()}),$scope.logout=function(){AuthenticationService.ClearCredentials(),$rootScope.$broadcast("login-state-changed"),$scope.isVerified=!1,$scope.unverifiedUsers=[]},$scope.showGetImagePopup=function(){var shouldCloseSilently=!1,isDataValid=function(data){var valid=!0;return angular.isNullOrUndefined(data)?(valid=!1,!1):angular.isNullOrUndefined(data.postcode)?(valid=!1,!1):angular.isNullOrUndefined(data.imageResourceId)?(valid=!1,!1):(4!=(""+data.imageResourceId).length&&(valid=!1),valid)};$scope.data={},$ionicPopup.show({template:'<div>       <input type="number" placeholder="Pin Code" ng-model="data.postcode">       <input type="number" placeholder="ResourceId" ng-model="data.imageResourceId">      </div>',title:"Details",subTitle:"Enter the details of the resource to attach the image to.",scope:$scope,buttons:[{text:"Cancel",onTap:function(e){shouldCloseSilently=!0}},{text:"<b>Next</b>",type:"button-positive",onTap:function(e){if(isDataValid($scope.data))return $scope.data;e.preventDefault(),console.log("Data is not valid, data",$scope.data)}}]}).then(function(response){if(angular.isNullOrUndefined(response))return null;var postcode=response.postcode,imageResourceId=response.imageResourceId;return getImage().then(function(data){return console.log("get image data",data),ApiService.uploadImageForResource(postcode,imageResourceId,data)})}).then(function(){shouldCloseSilently||displayMessage("Thanks.","Updated image successfully!")}).catch(function(err){console.log("Error getting image",err),displayMessage("Error updating image",err.statusText)})};var getImage=function(){return new Promise(function(resolve,reject){if(angular.isNullOrUndefined(navigator)||angular.isNullOrUndefined(navigator.camera))return displayMessage("Error","The camera is not available on your device"),reject(new Error("Unsupported device"));navigator.camera.getPicture(resolve,reject,{quality:10,destinationType:Camera.DestinationType.DATA_URL,targetWidth:500,targetHeight:250,sourceType:Camera.PictureSourceType.CAMERA})})},displayMessage=function(title,message){$ionicPopup.alert({title:title,template:message})}}),angular.module("controller.signup",[]).controller("SignupController",function($scope,$location,SignupService,AuthenticationService,$window,debug){$scope.user={},$scope.signup=function(){if($window.location.reload(!0),1==debug)return AuthenticationService.SetCredentials("lewis",1,"password"),void $location.path("/tab/map");SignupService.signUp($scope.user).then(function(data){console.log("Controller success: "+data),AuthenticationService.Login($scope.user).then(function(response){AuthenticationService.getCredentials().then(function(credentialsData){AuthenticationService.SetCredentials($scope.user.username,credentialsData.data.userID,$scope.user.password),$location.path("/tab/map")},function(data){console.log("Error getting user info")})},function(data){console.log("Login Error")})},function(data){console.log("contorller Error")})}}),angular.module("controller.village-detail",["nvd3"]).controller("VillageDetailController",function($scope,$state,ApiService,$stateParams){$scope.$on("$ionicView.enter",function(e){}),$scope.villageId=$stateParams.villageId}),angular.module("service.api",[]).service("ApiService",function($http,$q,$rootScope,apiUrl,AuthenticationService,$localstorage,CachingService){function uploadImageForResource(postcode,resourceId,data){return $http({method:"put",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/resources/"+resourceId+"?access_token="+AuthenticationService.getAccessToken(),data:{image:data,postcode:postcode}})}function getResource(postcode,resourceId){var query={where:{and:[{postcode:postcode},{id:resourceId}]}},url=apiUrl+"/api/resources?filter="+encodeURIComponent(JSON.stringify(query));return $http({method:"get",headers:{"Content-Type":"application/json"},url:url}).then(function(response){return response.data[0]})}function getReadingsByWeek(postcode,resourceId){return $http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/readings/readingsByWeek?postcode="+postcode+"&resourceId="+resourceId})}function getResourceReadings(postcode,resourceId){
var requestUrl="/api/readings?filter=%7B%22where%22%3A%7B%22and%22%3A%5B%7B%22postcode%22%3A"+postcode+"%7D%2C%7B%22resourceId%22%3A"+resourceId+"%7D%5D%7D%2C%20%22order%22%3A%20%22date%20ASC%22%7D&access_token="+AuthenticationService.getAccessToken();return $http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+requestUrl})}function getDifferenceFromJune(resourceType,readingType,resourceId,postcode){var requestUrl="/api/resource_stats/getDifferenceFromJune?readingType="+readingType+"&resourceId="+resourceId+"&postcode="+postcode;return angular.isNullOrUndefined(resourceType)||(requestUrl+="&resourceType={$resourceType}"),$http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+requestUrl})}function getVillages(){return Promise.resolve(!0).then(function(){return showLoadingIndicator()}).then(function(){return $http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/villages"})}).then(function(response){return hideLoadingIndicator(),response.data}).catch(function(err){return hideLoadingIndicator(),Promise.reject(err)})}function getResources(){return $http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/resources?filter=%7B%22fields%22%3A%7B%22image%22%3Afalse%7D%7D"}).then(function(response){return $localstorage.setObject("getResourcesCache",response),response}).catch(function(err){var cached=$localstorage.getObject("getResourcesCache");return angular.isNullOrUndefined(cached)?Promise.reject(err):cached})}function getClosestVillage(villageId){return $http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/villages/closestVillage?villageId="+villageId})}function updateReading(reading){return $http({method:"post",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/readings?access_token="+AuthenticationService.getAccessToken(),data:reading})}function registerWell(resource){return $http({method:"post",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/resources?access_token="+AuthenticationService.getAccessToken(),data:resource})}function login(username,password){return $http({method:"post",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/Users/login",data:{username:username,password:password}})}function getCurrentVillageAverage(postcode,resourceId){var villageId=resourceId.substring(0,2);return $http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/resource_stats/getCurrentVillageAverage?villageId="+villageId+"&postcode="+postcode}).catch(function(err){if(404!==err.status)return Promise.reject(err);console.log("No current village reading")})}function getStatisticsForResource(postcode,resourceId){var villageId=resourceId.substring(0,2),skip404Error=function(err){if(console.log("err",err),404!==err.status)return Promise.reject(err)};return Promise.all([$http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/resources/"+resourceId+"&postcode="+postcode}).catch(function(err){return skip404Error(err)}),$http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/resource_stats/getCurrentVillageAverage?villageId="+villageId+"&postcode="+postcode}).catch(function(err){return skip404Error(err)}),$http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/resource_stats/getHistoricalResourceAverages?resourceId="+resourceId+"&postcode="+postcode}).catch(function(err){return skip404Error(err)}),$http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/resource_stats/getHistoricalVillageAverages?villageId="+villageId+"&postcode="+postcode}).catch(function(err){return skip404Error(err)})])}function processExcelFile(fileResponse){return Promise.resolve(!0).then(function(){return showSlowLoadingIndicator()}).then(function(){return $http(_defineProperty({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/readings/processExcelFile?container="+fileResponse.container+"&name="+fileResponse.name+"&access_token="+AuthenticationService.getAccessToken(),timeout:6e5},"headers",{timeout:1e3,Connection:"Keep-Alive"}))}).then(function(res){return hideLoadingIndicator(),res}).catch(function(err){return hideLoadingIndicator(),Promise.reject(err)})}function showLoadingIndicator(){$rootScope.$broadcast("loading:show")}function showSlowLoadingIndicator(){$rootScope.$broadcast("loading:show-slow")}function hideLoadingIndicator(){$rootScope.$broadcast("loading:hide")}return{getResources:getResources,getVillages:getVillages,getClosestVillage:getClosestVillage,registerWell:registerWell,updateReading:updateReading,login:login,getStatisticsForResource:getStatisticsForResource,processExcelFile:processExcelFile,getDifferenceFromJune:getDifferenceFromJune,getResourceReadings:getResourceReadings,getResource:getResource,uploadImageForResource:uploadImageForResource,getReadingsByWeek:getReadingsByWeek,getCurrentVillageAverage:getCurrentVillageAverage}}),function(){angular.module("service.authentication",[]).factory("AuthenticationService",function($http,$rootScope,$timeout,$location,$localstorage,UserService){function Login(user){return LoginService.login(user)}function Logout(){ClearCredentials()}function getCredentials(){return UserService.getUserDetails()}function getAccessToken(){return console.log("user details",$rootScope.globals.currentUser.authToken),$rootScope.globals.currentUser.authToken}function SetCredentials(user,authToken){$rootScope.globals={currentUser:{userID:user.id,authToken:authToken,username:user.user_name,verified:user.verified,service:user.service}},$localstorage.setObject("globals",$rootScope.globals)}function ClearCredentials(){console.log("Clearing Credentials"),$rootScope.globals={},$localstorage.delete("globals"),$http.defaults.headers.common.Authorization="Basic"}var service={};return service.Login=Login,service.getCredentials=getCredentials,service.SetCredentials=SetCredentials,service.ClearCredentials=ClearCredentials,service.getAccessToken=getAccessToken,service.Logout=Logout,service})}(),angular.module("service.login",[]).service("LoginService",["$http","$q","apiUrl","AuthenticationService","$rootScope",function($http,$q,apiUrl,AuthenticationService,$rootScope){function reAuthenticateUser(){return $q(function(resolve,reject){var currentUser=$rootScope.globals.currentUser;currentUser?login(currentUser.service,currentUser.authToken).then(function(response){resolve(response)},function(error){reject("Error")}):reject("User is not logged in")})}function login(service,token){return $q(function(resolve,reject){switch(showLoadingIncicator(),service){case"facebook":Azureservice.login("facebook",token).then(function(results){var currentUser=Azureservice.getCurrentUser();console.log("Current user: "+JSON.stringify(currentUser)),Azureservice.invokeApi("authenticateuser",{body:{service:"facebook",user:Azureservice.getCurrentUser()},method:"post"}).then(function(response){console.log("Azure success: "+JSON.stringify(response)),AuthenticationService.SetCredentials(response,currentUser.mobileServiceAuthenticationToken),resolve("Success")},function(err){console.error("Azure Error: "+err),hideLoadingIndicator(),reject("Error")})},function(error){hideLoadingIndicator(),alert(error),reject("Error")});break;case"twitter":Azureservice.login("twitter",token).then(function(results){var currentUser=Azureservice.getCurrentUser();console.log("Current user: "+JSON.stringify(currentUser)),Azureservice.invokeApi("authenticateuser",{body:{service:"twitter",user:Azureservice.getCurrentUser()},method:"post"}).then(function(response){console.log("Azure success: "+JSON.stringify(response)),AuthenticationService.SetCredentials(response,currentUser.mobileServiceAuthenticationToken),resolve("Success")},function(err){hideLoadingIndicator(),console.error("Azure Error: "+err),reject("Error")})},function(error){hideLoadingIndicator(),alert(error),reject("Error")});break;default:Azureservice.login("google",token).then(function(results){var currentUser=Azureservice.getCurrentUser();console.log("Current user: "+JSON.stringify(currentUser)),Azureservice.invokeApi("authenticateuser",{body:{service:"google",user:Azureservice.getCurrentUser()},method:"post"}).then(function(response){console.log("Azure success: "+JSON.stringify(response)),AuthenticationService.SetCredentials(response,currentUser.mobileServiceAuthenticationToken),resolve("Success")},function(err){hideLoadingIndicator(),console.error("Azure Error: "+err),reject("Error")})},function(error){hideLoadingIndicator(),alert(error),reject("Error")})}})}function logout(){return $http({method:"post",url:apiUrl+"/logout"}).then(handleSuccess,handleError)}function handleError(response){return angular.isObject(response.data)&&response.data.message?$q.reject(response.data.message):$q.reject("An Unknown error occoured")}function handleSuccess(response){return response.data}function showLoadingIncicator(){$rootScope.$broadcast("loading:show")}function hideLoadingIndicator(){$rootScope.$broadcast("loading:hide")}return{login:login,logout:logout,reAuthenticateUser:reAuthenticateUser}}]),angular.module("service.signup",[]).service("SignupService",function($http,$q,apiUrl){function signUp(user){var baseUrl=apiUrl,method="post";return constants.offline&&(method="get"),$http({method:method,headers:{"Content-Type":"application/json"},url:baseUrl+"/signup",data:user}).success(function(data){console.log("Success")}).error(function(){console.log("Error")})}return{signUp:signUp}}),angular.module("service.user",[]).service("UserService",function($http,$q,$rootScope,apiUrl){function getUser(userID){return userID&&-1!==userID||(userID=getCurrentUserID()),$http({method:"get",headers:{"Content-Type":"application/json"},url:apiUrl+"/api/user/"+userID}).success(function(data){}).error(function(){})}function getUserDetails(){return $http({method:"get",url:apiUrl+"/api/user/current"})}function getCurrentUserID(){return $rootScope.globals.currentUser.userID}return{getUser:getUser,getUserDetails:getUserDetails,getCurrentUserID:getCurrentUserID}});
//# sourceMappingURL=maps/dist.js.map
