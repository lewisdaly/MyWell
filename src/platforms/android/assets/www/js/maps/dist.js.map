{"version":3,"sources":["app.js","constants.js","utils.js","controller/AppController.js","controller/LoginController.js","controller/MapController.js","controller/MapDetailController.js","controller/RegisterController.js","controller/ReportController.js","controller/SettingsController.js","controller/SignupController.js","controller/VillageDetailController.js","service/ApiService.js","service/AuthenticationService.js","service/LoginService.js","service/SignupService.js","service/UserService.js"],"names":["angular","module","run","$ionicPlatform","$rootScope","$ionicLoading","$location","$http","$localstorage","ready","window","cordova","plugins","Keyboard","hideKeyboardAccessoryBar","disableScroll","codePushCallback","syncStatus","SyncStatus","APPLY_SUCCESS","UP_TO_DATE","UPDATE_IGNORED","ERROR","console","log","options","installMode","InstallMode","ON_NEXT_RESTART","updateDialog","codePush","sync","globals","getObject","$on","show","template","hide","config","$compileProvider","$stateProvider","$urlRouterProvider","$httpProvider","adalProvider","init","instance","tenant","clientId","extraQueryParameter","$provide","debug","adalAuthenticationServiceProvider","state","url","templateUrl","controller","abstract","views","tab-map","tab-report","tab-chats","tab-settings","otherwise","decorator","$delegate","exception","cause","data","type","location","hash","localtime","Date","now","message","name","stack","alert","track","onerror","line","col","error","stopPropagation","fileName","lineNumber","columnNumber","isNullOrUndefined","val","isUndefined","constant","factory","$window","set","key","value","localStorage","get","defaultValue","setObject","JSON","stringify","parse","err","delete","removeItem","API_URL","API_KEY","service","getReportCache","findOrCreateReportCache","getReportAtIndex","index","deleteReportAtIndex","reportCache","splice","saveReportCache","addReportToCache","report","push","addResourceToCache","getResourceFromCache","resourceCache","saveFavouriteLocation","lat","lng","locationArray","getFavouriteLocation","$scope","$ionicModal","AuthenticationService","$state","LoginService","ApiService","buttonState","lastCodeState","currentUser","isLoggedIn","then","catch","logout","login","tryLastTokenLogin","$broadcast","any","email","mobile_number","tel","modal","codeState","shouldClear","ClearCredentials","isVerified","unverifiedUsers","cancel","e","shouldDisablePhoneButton","$modelValue","length","$isInvalid","shouldDisableEmailButton","test","switchService","getCodeSMS","replace","sendLoginCodeSMS","getCodeEmail","sendLoginCodeEmail","isCodeValid","code","valid","performLogin","loginWithCode","response","status","user","id","userId","authToken","username","verified","SetCredentials","resetLogin","fromTemplateUrl","scope","animation","remove","go","current","reload","$ionicPopup","signup","path","apiUrl","$ionicHistory","CachingService","saftelyGetLevelString","toFixed","getPopupContentForResource","resource","postcode","villageId","village","villageName","specificContent","ResourceType","WELL","getSpecificContentForWell","CHECKDAM","getSpecificContentForCheckDam","RAINGAUGE","getSpecificContentForRainGauge","getVillageName","leafletMap","invalidateSize","wellIcon","L","icon","iconUrl","iconSize","iconAnchor","popupAnchor","checkdamIcon","raingaugeIcon","markers","isPageActive","closestVillage","searchResource","getMarkerIdForVillage","getMarkerIdForResource","resetMap","Object","keys","forEach","_key","marker","removeLayer","loadDataAndSetupMap","getVillages","villages","divIcon","html","className","coordinates","addTo","getResources","map","percentageFull","well_depth","last_value","geo","bindPopup","zoomControl","minZoom","maxZoom","tileLayer","firstLocation","savedResource","setView","filter","searchItemPressed","event","hideSearchResults","document","getElementById","blur","close","panTo","LatLng","openPopup","addEventListener","locate","navigator","geolocation","getCurrentPosition","position","coords","latitude","longitude","showSearchResults","showSearchPanel","watchSearch","search","refreshDataPressed","$stateParams","setupData","getResource","resourceId","Promise","all","getReadingsByWeek","getReadingsByWeekMethod","getCurrentVillageAverage","results","readingsByWeek","allWeeklyReadings","readings","weeks","juneData","pastReadingDate","toISOString","slice","difference","readingValue","villageAverageReading","avgReading","stats","slicePoints","splitWeeklyReadings","setupResourceType","setupChart","detailChart","graphLabel","shouldReverseGraph","readableResourceType","getChartDataAndLabel","dataRange","dataAndLabel","labels","dateTime","moment","format","Error","colors","border","background","chartData","ctx","Chart","datasets","label","borderWidth","backgroundColor","borderColor","fill","title","display","text","spanGaps","scales","yAxes","ticks","beginAtZero","reverse","updateData","update","input","charAt","toUpperCase","substr","toLowerCase","resources","refreshCoords","center","getCenter","form","elevation","max_wt_depth","dragging","doubleClickZoom","$apply","checkAndUpdateMap","toString","$watch","submit","isFormValid","village_name","trim","owner","registerWell","goBack","displayMessage","statusText","Upload","checkUserStatus","isUserNotLoggedIn","isUserNotVerified","isUserLoggedInAndVerified","resetForm","date","cachedReports","refreshUser","reAuthenticateUser","readingTypes","well","valuePlaceholder","raingauge","checkdam","readingType","setReadingType","sendReport","substring","toDateString","updateReading","upload","file","resp","resolve","result","files","evt","progressPercentage","parseInt","loaded","total","fileResponse","processExcelFile","res","created","warnings","clearFile","submitFile","$valid","version_number","apiBaseUrl","imageResourceId","isDesktop","showGetImagePopup","shouldCloseSilently","isDataValid","subTitle","buttons","onTap","preventDefault","getImage","uploadImageForResource","reject","camera","getPicture","quality","destinationType","Camera","DestinationType","DATA_URL","targetWidth","targetHeight","sourceType","PictureSourceType","CAMERA","SignupService","signUp","Login","getCredentials","credentialsData","userID","password","$q","method","headers","Content-Type","getAccessToken","image","query","where","and","encodeURIComponent","getResourceReadings","requestUrl","getDifferenceFromJune","resourceType","showLoadingIndicator","hideLoadingIndicator","cached","getClosestVillage","reading","optional_token","getStatisticsForResource","skip404Error","showSlowLoadingIndicator","container","timeout","Connection","$timeout","UserService","Logout","getUserDetails","lastUser","statusCode","user_name","defaults","common","Authorization","token","showLoadingIncicator","Azureservice","getCurrentUser","invokeApi","body","mobileServiceAuthenticationToken","handleSuccess","handleError","isObject","baseUrl","constants","offline","success","getUser","getCurrentUserID"],"mappings":"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","file":"../dist.js","sourcesContent":["// Ionic Starter App\n\n// angular.module is a global place for creating, registering and retrieving Angular modules\n// 'starter' is the name of this angular module example (also set in a <body> attribute in index.html)\n// the 2nd parameter is an array of 'requires'\n// 'starter.services' is found in services.js\n// 'starter.controllers' is found in controllers.js\nangular.module('starter', [\n  'ionic',\n  'ngMap',\n  'ngFileUpload',\n  'starter.controllers',\n  'report.controllers',\n  'controller.settings',\n  'rainapp-constants',\n  'ngIOS9UIWebViewPatch',\n  'controller.signup',\n  'controller.login',\n  'controller.map',\n  'controller.register',\n  'controller.map-detail',\n  'controller.village-detail',\n\n  'service.authentication',\n  'service.login',\n  'service.signup',\n  'service.user',\n  'service.api',\n  'rainapp.utils',\n  'AdalAngular',\n  // 'ngIntlTelInput'\n  'intlpnIonic'\n  ])\n\n.run(function($ionicPlatform, $rootScope, $ionicLoading, $location, $http, $localstorage) {\n  $ionicPlatform.ready(() => {\n    if (window.cordova && window.cordova.plugins && window.cordova.plugins.Keyboard) {\n      cordova.plugins.Keyboard.hideKeyboardAccessoryBar(true);\n      cordova.plugins.Keyboard.disableScroll(true);\n    } else {\n      //Don't the followind codepush things if we don't have cordova\n      return;\n    }\n\n    const codePushCallback = syncStatus => {\n      switch (syncStatus) {\n        case SyncStatus.APPLY_SUCCESS:\n        case SyncStatus.UP_TO_DATE:\n        case SyncStatus.UPDATE_IGNORED:\n          break;\n        case SyncStatus.ERROR:\n          console.log(\"codesync error\");\n          break;\n      }\n    };\n\n    const options = {\n      installMode: InstallMode.ON_NEXT_RESTART, updateDialog: true\n    };\n\n    window.codePush.sync(codePushCallback, options);\n  });\n// });\n\n  //keep user logged in after page refresh\n  //http://jasonwatmore.com/post/2015/03/10/AngularJS-User-Registration-and-Login-Example.aspx\n  $rootScope.globals = $localstorage.getObject('globals');\n  if ($rootScope.globals){\n    // if ($rootScope.globals.currentUser) {\n    //   $http.defaults.headers.common['Authorization'] = 'Basic ' + $rootScope.globals.currentUser.authdata;\n    // }\n  } else {\n    $rootScope.globals = {};\n  }\n\n  //Refer to: http://learn.ionicframework.com/formulas/loading-screen-with-interceptors/\n  //Loading indicators and callbacks\n  $rootScope.$on('loading:show', function() {\n    $ionicLoading.show({\n      template: '<ion-spinner></ion-spinner>'\n    });\n  })\n\n  $rootScope.$on('loading:show-slow', function() {\n    $ionicLoading.show({\n      template: 'Please wait, this may take up to 10 minutes</br><ion-spinner></ion-spinner>'\n    });\n  })\n\n  $rootScope.$on('loading:hide', function() {\n    $ionicLoading.hide();\n  })\n})\n\n//The ADAL Provider - Auth and Stuff\n.config(['$compileProvider', '$stateProvider', '$urlRouterProvider', '$httpProvider', 'adalAuthenticationServiceProvider',\n  function ($compileProvider, $stateProvider, $urlRouterProvider, $httpProvider, adalProvider) {\n    adalProvider.init(\n    {\n      instance: 'https://login.microsoftonline.com/',\n      tenant: '35a32751-a7a4-47e9-830e-d320e5e2ce25',//'contoso.onmicrosoft.com', //not sure if this is right...\n      clientId: '18841449-2afd-4fdb-9246-0f7e461c61f8',\n      extraQueryParameter: 'nux=1',\n      //cacheLocation: 'localStorage', // enable this for IE, as sessionStorage does not work for localhost.\n    },\n    $httpProvider\n    );\n  }])\n\n// .config(function (ngIntlTelInputProvider) {\n//    ngIntlTelInputProvider.set({initialCountry: 'in', onlyCountries: [\"in\", \"au\"]});\n//  })\n\n.config(function($stateProvider, $urlRouterProvider, $provide, debug, adalAuthenticationServiceProvider) {\n  $stateProvider\n  .state('login', {\n    url: '/login',\n    templateUrl: 'templates/login.html',\n    controller: 'LoginController'\n  })\n\n  .state('signup', {\n    url: '/signup',\n    templateUrl: 'templates/signup.html',\n    controller: 'SignupController'\n  })\n\n\n  // setup an abstract state for the tabs directive\n  .state('tab', {\n    url: '/tab',\n    abstract: true,\n    templateUrl: 'templates/tabs.html',\n\n  })\n\n  // Each tab has its own nav history stack:\n\n  .state('tab.map', {\n    url: '/map',\n    // requireADLogin: true,\n    views: {\n      'tab-map': {\n        templateUrl: 'templates/tab-map.html',\n        //TODO: change this name\n        controller: 'MapCtrl'\n      }\n    }\n  })\n  // Map detail page\n  .state('tab.map-detail', {\n    url: '/map/:postcode/:resourceId',\n    views: {\n      'tab-map': {\n        templateUrl: 'templates/map-detail.html',\n        controller: 'MapDetailController'\n      }\n    }\n  })\n  //Village Detail Page\n  .state('tab.village-detail', {\n    url: '/map/:postcode/village/:villageId',\n    views: {\n      'tab-map': {\n        templateUrl: 'templates/village-detail.html',\n        controller: 'VillageDetailController'\n      }\n    }\n  })\n  .state('tab.report', {\n    url: '/report',\n    // requireADLogin: true,\n    views: {\n      'tab-report': {\n        templateUrl: 'templates/tab-report.html',\n        controller: 'ReportController'\n      }\n    }\n  })\n  .state('tab.chat-detail', {\n    url: '/chats/:chatId',\n    // requireADLogin: true,\n    views: {\n      'tab-chats': {\n        templateUrl: 'templates/chat-detail.html',\n        controller: 'ChatDetailCtrl'\n      }\n    }\n  })\n\n  .state('tab.settings', {\n    url: '/settings',\n    // requireADLogin: true,\n    views: {\n      'tab-settings': {\n        templateUrl: 'templates/tab-settings.html',\n        controller: 'SettingsController'\n      }\n    }\n  })\n\n  //Register  page\n  .state('tab.settings-register', {\n    url: '/settings/register',\n    views: {\n      'tab-settings': {\n        templateUrl: 'templates/register.html',\n        controller: 'RegisterController'\n      }\n    }\n  });\n\n  // if none of the above states are matched, use this as the fallback\n  $urlRouterProvider.otherwise('/tab/map');\n\n  // catch exceptions in angular - http://forum.ionicframework.com/t/error-tracking-in-angular/8641\n  $provide.decorator('$exceptionHandler', ['$delegate', function($delegate){\n    return function(exception, cause){\n      $delegate(exception, cause);\n\n      var data = {\n        type: 'angular',\n        url: window.location.hash,\n        localtime: Date.now()\n      };\n      if(cause)               { data.cause    = cause;              }\n      if(exception){\n        if(exception.message) { data.message  = exception.message;  }\n        if(exception.name)    { data.name     = exception.name;     }\n        if(exception.stack)   { data.stack    = exception.stack;    }\n      }\n\n      if(debug == 1){\n        console.log('exception', data);\n        window.alert('Error: '+data.message);\n      } else {\n        track('exception', data);\n      }\n    };\n  }]);\n\n  // catch exceptions out of angular\n  window.onerror = function(message, url, line, col, error){\n    var stopPropagation = debug ? false : true;\n    var data = {\n      type: 'javascript',\n      url: window.location.hash,\n      localtime: Date.now()\n    };\n    if(message)       { data.message      = message;      }\n    if(url)           { data.fileName     = url;          }\n    if(line)          { data.lineNumber   = line;         }\n    if(col)           { data.columnNumber = col;          }\n    if(error){\n      if(error.name)  { data.name         = error.name;   }\n      if(error.stack) { data.stack        = error.stack;  }\n    }\n\n    if(debug == 1){\n      console.log('exception', data);\n      window.alert('Error: '+data.message);\n    } else {\n      track('exception', data);\n    }\n    return stopPropagation;\n  };\n});\n\n\nangular.isNullOrUndefined = function(val) {\n  return angular.isUndefined(val) || val === null;\n}\n","angular.module('rainapp-constants',[])\n  .constant('apiUrl', 'https://dev-mywell-server.marvi.org.in')\n  .constant('debug', '1')\n  .constant('version_number', 'dev_1.3.4');\n","\"use strict\";\nangular.module('rainapp.utils', [])\n\n//localStorage utility\n.factory('$localstorage', ['$window', function($window) {\n  return {\n    set: function(key, value) {\n      $window.localStorage[key] = value;\n    },\n    get: function(key, defaultValue) {\n      return $window.localStorage[key] || defaultValue;\n    },\n    setObject: function(key, value) {\n      $window.localStorage[key] = JSON.stringify(value);\n    },\n    getObject: function(key) {\n      try {\n        let parsedJson = JSON.parse($window.localStorage[key]);\n        return parsedJson;\n      } catch (err) {\n        return null;\n      }\n    },\n    delete: function(key) {\n    \t$window.localStorage.removeItem(key);\n    }\n  }\n}])\n\n.constant('AzureMobileServiceClient', {\n    API_URL : \"https://watermanagementmobile.azure-mobile.net/\",\n    API_KEY : \"vQWzbtVFXjBmcfKYtVmYPVkCzjynlo72\"\n  })\n\n.service('CachingService', function($localstorage) {\n  return ({\n    getReportCache: getReportCache,\n    getReportAtIndex: getReportAtIndex,\n    deleteReportAtIndex:deleteReportAtIndex,\n    addReportToCache:addReportToCache,\n    addResourceToCache: addResourceToCache,\n    getResourceFromCache: getResourceFromCache,\n    saveFavouriteLocation: saveFavouriteLocation,\n    getFavouriteLocation: getFavouriteLocation\n  });\n\n  //get the cached reports from local storage.\n  //Create if it doesn't exist\n  function getReportCache() {\n    return findOrCreateReportCache();\n  }\n\n  function getReportAtIndex(index) {\n    let reportCache = getReportCache();\n    return reportCache[index];\n  }\n\n  /**\n   * Delete a report at given index and update local storage\n   */\n  function deleteReportAtIndex(index) {\n    let reportCache = findOrCreateReportCache();\n    reportCache.splice(index, 1);\n\n    return saveReportCache(reportCache);\n  }\n\n  /**\n   * add a report and save to local storage\n   */\n  function addReportToCache(report) {\n    let reportCache = findOrCreateReportCache();\n    //TODO: validate report here?\n    reportCache.push(report);\n\n    return saveReportCache(reportCache);\n  }\n\n  /* Private functions */\n\n  function findOrCreateReportCache() {\n    let reportCache = $localstorage.getObject('reportCache');\n    if (!angular.isNullOrUndefined(reportCache)) {\n      return reportCache;\n    }\n\n    //Cache doesn't exist. Create it here\n    reportCache = [];\n    return saveReportCache(reportCache);\n  }\n\n  function saveReportCache(reportCache) {\n    $localstorage.setObject('reportCache', reportCache);\n    return reportCache;\n  }\n\n  function addResourceToCache(data) {\n    $localstorage.setObject('resourceCache', data);\n  }\n\n  function getResourceFromCache() {\n    let resourceCache = $localstorage.getObject('resourceCache');\n    if (angular.isNullOrUndefined(resourceCache)) {\n      return {};\n    }\n\n    return resourceCache;\n  }\n\n  function saveFavouriteLocation(lat, lng) {\n    console.log(\"Saving favourite location:\", lat, lng);\n    const locationArray = [lat, lng];\n    $localstorage.setObject('favouriteLocation', locationArray);\n  }\n\n  function getFavouriteLocation() {\n    const location = $localstorage.getObject('favouriteLocation');\n    console.log(\"Getting favouriteLocation:\", location);\n    return location;\n  }\n});\n","angular.module('starter.controllers', ['ionic'])\n.controller('AppController', function($scope, $ionicModal, AuthenticationService, $state, $rootScope, LoginService, ApiService, $localstorage) {\n\n  /*\n    codeState:\n      - getCodeSMS - user must enter phone number\n      - getCodeEmail - user must enter email address\n      - enterCode - message has been sent, waiting for user to enter code\n\n    buttonState:\n      - loading - something is happening!\n      - userInput - waiting for userInput\n  */\n\n\t//Init\n\t//Check to see if user is logged in.\n  $scope.buttonState = 'userInput';\n  $scope.lastCodeState = '';\n\tvar currentUser = $rootScope.globals.currentUser;\n  if (!currentUser) {\n    $scope.isLoggedIn = false;\n  } else {\n    //We have a token, but we don't know that its valid\n    ApiService.isLoggedIn()\n      .then(() => $scope.isLoggedIn = true)\n      .catch(err => {\n        //TODO: only clear on a 401\n        console.log(\"User is no longer logged in\", err);\n        $scope.isLoggedIn = false;\n        //logout, but still hold onto the credentials just in case\n        $scope.logout();\n      });\n  }\n\n\t$scope.login = function() {\n    //Try to login with last saved token first:\n    return AuthenticationService.tryLastTokenLogin()\n      .then(() => {\n        $rootScope.$broadcast('login-state-changed', { any: {} });\n      })\n      .catch(err => {\n        console.log(\"err\", err);\n\n        $scope.email = $localstorage.get('last_entered_email', '');\n        $scope.mobile_number = $localstorage.get('last_entered_mobile_number', '');\n        $scope.tel = $localstorage.get('last_entered_mobile_number', '');\n\n        $scope.modal.show();\n        $scope.codeState = 'getCodeEmail';\n      });\n\t}\n\n\t$scope.logout = function(shouldClear) {\n    AuthenticationService.ClearCredentials();\n\t\t$rootScope.$broadcast('login-state-changed');\n\t\t$scope.isVerified = false;\n\t\t$scope.unverifiedUsers = [];\n\t}\n\n\t$scope.cancel = function() {\n\t\t$scope.modal.hide();\n\t}\n\n\t$scope.$on('login-state-changed', function(e) {\n\t\tvar currentUser = $rootScope.globals.currentUser;\n\t\tif(currentUser) {\n\t\t\t$scope.isLoggedIn = true;\n\t\t}\n\t\telse {\n\t\t\t$scope.isLoggedIn = false;\n\t\t}\n\t})\n\n  $scope.shouldDisablePhoneButton = function(tel) {\n    if (!tel) {\n      return true;\n    }\n\n    if (!tel.$modelValue || tel.$modelValue.length == 0) {\n      return true;\n    }\n\n    if (tel.$isInvalid) {\n      return true;\n    }\n\n    return false;\n  }\n\n  $scope.shouldDisableEmailButton = function(email) {\n    var re = /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;\n    return !re.test(email);\n  }\n\n  $scope.switchService = function() {\n    console.log($scope.codeState);\n    if ($scope.codeState === \"getCodeSMS\") {\n      $scope.codeState = \"getCodeEmail\";\n      return;\n    }\n\n    $scope.codeState = \"getCodeSMS\";\n  }\n\n  //Send the request to make the 1 time code\n  $scope.getCodeSMS = function(mobile_number) {\n    $localstorage.set('last_entered_mobile_number', mobile_number);\n    $scope.lastCodeState = 'getCodeSMS';\n    $scope.email = '';\n\n    //get rid of first '+'\n    $scope.mobile_number = mobile_number.replace(\"+\", \"\");\n    //TODO: send message\n    $scope.buttonState = 'loading';\n    return ApiService.sendLoginCodeSMS(mobile_number)\n      .then(() => {\n        $scope.buttonState = 'userInput';\n        $scope.codeState = 'enterCode';\n      })\n      .catch(err => {\n        console.log(\"Err\", err);\n        $scope.buttonState = 'userInput';\n        $scope.codeState = $scope.lastCodeState;\n        window.alert('Error sending login code. Please try again.');\n      })\n  }\n\n  $scope.getCodeEmail = function(email) {\n    $localstorage.set('last_entered_email', email);\n    $scope.mobile_number = '';\n    $scope.lastCodeState = 'getCodeEmail';\n\n    $scope.buttonState = 'loading';\n\n    return ApiService.sendLoginCodeEmail(email)\n      .then(() => {\n        $scope.buttonState = 'userInput';\n        $scope.codeState = 'enterCode';\n      })\n      .catch(err => {\n        console.log(\"Err\", err);\n        $scope.buttonState = 'userInput';\n        $scope.codeState = $scope.lastCodeState;\n        window.alert('Error sending login code. Please try again.');\n      });\n  }\n\n  $scope.isCodeValid = function(code) {\n    let valid = true;\n\n    if (!code) {\n      valid = false;\n      return valid;\n    }\n\n    if (code.length !== 6) {\n      valid = false\n    }\n    return valid;\n  }\n\n  //Perform the login\n  $scope.performLogin = function(mobile_number, email, code) {\n    console.log(\"Performing login\", mobile_number, email, code);\n\n    return ApiService.loginWithCode(mobile_number, email, code)\n      .then(response => {\n        console.log(response);\n        if (response.status === 200) {\n          //login\n          const user = {\n            id: response.data.userId,\n            authToken:response.data.id,\n            username: 'marvi',\n            verified: true,\n            service: 'none'\n          };\n          AuthenticationService.SetCredentials(user, response.data.id);\n          $scope.modal.hide();\n        } else {\n          window.alert('Login Error: '+ response.status);\n        }\n      })\n      .catch(function (err){\n        console.log(\"err\", err);\n        window.alert('Login Error: '+ err.status);\n      });\n  }\n\n  $scope.resetLogin = function() {\n    $scope.codeState = 'getCodeSMS';\n    $scope.buttonState = 'userInput';\n    $scope.mobile_number = null;\n\n  }\n\n  //TODO: remember number (using local storage)\n\n\t$ionicModal.fromTemplateUrl('templates/login.html', {\n\t\tscope: $scope,\n\t\tanimation: 'slide-in-up'\n\t}).then(function(modal) {\n\t\t$scope.modal = modal;\n\t});\n\n  \t//Cleanup the modal when we're done with it!\n  \t$scope.$on('$destroy', function() {\n  \t\t$scope.modal.remove();\n  \t});\n  \t// Execute action on hide modal\n  \t$scope.$on('modal.hidden', function() {\n    \t// Execute action\n    \t$state.go($state.current, {}, {reload: true});\n    \t$rootScope.$broadcast('login-state-changed', { any: {} });\n\n    });\n  \t// Execute action on remove modal\n  \t$scope.$on('modal.removed', function() {\n   \t // Execute action\n   \t});\n\n  })\n;\n","angular.module('controller.login', [])\n.controller('LoginController', function($scope, $location, AuthenticationService,$ionicPopup, debug, $http){\n    $scope.user = {};\n\n    (function initController() {\n        // reset login status\n        AuthenticationService.ClearCredentials();\n    })();\n\n\n\n$scope.signup = function signup() {\n    $location.path('/signup');\n}\n});\n","angular.module('controller.map', [])\n\n.controller('MapCtrl', function($scope, apiUrl, $state, $window, $ionicHistory, $ionicModal, $ionicPopup, ApiService, CachingService) {\n\n  $scope.$on('$ionicView.enter', function(e) {\n    leafletMap.invalidateSize();\n  });\n\n  const ResourceType = {\n    WELL: 'well',\n    RAINGAUGE: 'raingauge',\n    CHECKDAM: 'checkdam'\n  };\n\n  const wellIcon = L.icon({iconUrl: 'img/ball.png', iconSize:[36, 36], iconAnchor:[0, 0], popupAnchor:[17, 5]});\n  const checkdamIcon = L.icon({iconUrl: 'img/wall.png',iconSize: [36, 36], iconAnchor: [-15, 0], popupAnchor: [17, 5]});\n  const raingaugeIcon = L.icon({iconUrl: 'img/raindrop.svg', iconSize: [36, 56], iconAnchor: [0,0], popupAnchor: [17, 5]});\n\n  $scope.markers = {}; //dict of Leaflet Marker Objects\n  $scope.data = []; //Data loaded from Server\n  $scope.isPageActive = true;\n  $scope.closestVillage = \"Varni\"; //default\n  $scope.searchResource = '';\n\n  const getMarkerIdForVillage = (village) => {\n    return `${village.postcode}-${village.id}`;\n  }\n\n  const getMarkerIdForResource = (resource) => {\n    return `${resource.postcode}-${resource.id}`;\n  }\n\n  const getFirstLocation = () => {\n    const savedResource = CachingService.getFavouriteLocation();\n    if (!savedResource) {\n      console.log(\"No first location!\");\n      return [24.593, 74.198];\n    }\n\n    return savedResource;\n  }\n\n  const resetMap = () => {\n    Object.keys($scope.markers).forEach(_key => {\n      let marker = $scope.markers[_key];\n      if (!marker) {\n        console.log(\"no marker for key:\", _key);\n        return;\n      }\n      leafletMap.removeLayer(marker);\n    });\n    //Trying this out - it may fix the greyness and popup position errors\n    //maybe call this whenever the page\n    leafletMap.invalidateSize();\n  }\n\n  const loadDataAndSetupMap = () => {\n    ApiService.getVillages()\n      .then(villages => {\n        $scope.villages = villages;\n        villages.forEach(village => {\n          const icon = L.divIcon({\n            html:`\\\n            <div class=\"\"> \\\n                <h2>${village.name}</h2> \\\n            </div>`,\n            className: 'village-div-icon'});\n          const marker = L.marker([village.coordinates.lat, village.coordinates.lng], {icon:icon}).addTo(leafletMap);\n          $scope.markers[getMarkerIdForVillage(village)] = marker;\n\n        });\n      })\n      .then(() => ApiService.getResources())\n      .then(function(response) {\n\n        //Manually join the village name\n        $scope.data = response.data.map(resource => {\n          resource.villageName = $scope.getVillageName(resource.postcode, resource.villageId);\n          return resource;\n        });\n\n        $scope.data.forEach(resource => {\n          //Calculate the well % level:\n          const percentageFull = (((resource.well_depth - resource.last_value)/resource.well_depth) * 100).toFixed(2);\n          resource.percentageFull = percentageFull;\n\n          let icon = null;\n          switch (resource.type) {\n            case ResourceType.WELL:\n              icon = wellIcon;\n              break;\n            case ResourceType.CHECKDAM:\n              icon = checkdamIcon;\n              break;\n            case ResourceType.RAINGAUGE:\n              icon = raingaugeIcon;\n              break;\n            default:\n              console.error(`Unknown ResourceType: ${resource.type}`);\n          }\n\n          var marker = L.marker([resource.geo.lat, resource.geo.lng], {icon:icon}).addTo(leafletMap);\n          marker.bindPopup(getPopupContentForResource(resource));\n          $scope.markers[getMarkerIdForResource(resource)] = marker;\n        });\n      });\n  }\n\n  //Set up the Leaflet Map\n  var leafletMap = L.map('leafletMap', { zoomControl:true, minZoom:5, maxZoom:18});\n  L.tileLayer('https://api.mapbox.com/styles/v1/lewisdaly/ciuqhjyzo00242iphq3wo7bm4/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibGV3aXNkYWx5IiwiYSI6ImNpdXE3ajltaDAwMGYyb2tkdjk2emx3NGsifQ.wnqFweA7kdijEtsgjTJIPw')\n   .addTo(leafletMap);\n\n  loadDataAndSetupMap();\n  const firstLocation = getFirstLocation();\n  leafletMap.setView(firstLocation, 16);\n\n  $scope.getVillageName = (postcode, villageId) => {\n    const village = $scope.villages.filter(village => village.postcode === postcode && village.id === villageId)[0]\n    if (!village) {\n      console.error(`Village not found for postcode: ${postcode} and villageId: ${villageId}`);\n      return \"null\";\n    }\n\n    return village.name;\n  };\n\n  // $scope.$on('$ionicView.enter', function(e) {\n  //   if ($scope.map) {\n  //     google.maps.event.trigger($scope.map, 'resize');\n  //   }\n  // });\n\n  /**\n   * Someone has clicked search. Get the resource from id, and navigate, also show popup\n   */\n  $scope.searchItemPressed = function(event, resource) {\n    $scope.hideSearchResults();\n    //disable text box\n    document.getElementById(\"search-box-input\").blur();\n    if (window.cordova && window.cordova.plugins && window.cordova.plugins.Keyboard) {\n      cordova.plugins.Keyboard.close();\n    }\n\n    var marker = $scope.markers[getMarkerIdForResource(resource)];\n    leafletMap.panTo(new L.LatLng(resource.geo.lat, resource.geo.lng));\n    marker.openPopup();\n  }\n\n  document.getElementById(\"search-box-input\").addEventListener('focus', function () {\n      console.log('focus on input ');\n  });\n\n  document.getElementById(\"search-box-input\").addEventListener('click', function () {\n      console.log('click on input');\n  });\n\n  $scope.locate = function() {\n    if (navigator.geolocation) {\n      navigator.geolocation.getCurrentPosition(function(position){\n        leafletMap.panTo(new L.LatLng(position.coords.latitude, position.coords.longitude));\n        //TODO: drop pin\n        // ion-ios-navigate\n      });\n    }\n    else {\n      console.log(\"Geolocation is not supported by this browser.\");\n    }\n  }\n\n  $scope.showSearchResults = () => {\n    $scope.showSearchPanel = true;\n  }\n\n  $scope.hideSearchResults = () => {\n    $scope.showSearchPanel = false;\n  }\n\n  $scope.watchSearch = (search) => {\n    $scope.searchResource = search;\n    if (search.length > 2) {\n      return $scope.showSearchResults();\n    }\n\n    return $scope.hideSearchResults();\n  }\n\n  $scope.refreshDataPressed = () => {\n    resetMap();\n    loadDataAndSetupMap();\n  }\n\n\n  function saftelyGetLevelString(value) {\n    if (angular.isNullOrUndefined(value)) {\n      return \"\";\n    }\n    return value.toFixed(2);\n  }\n\n  function displayMessage(title, message) {\n    var alertPopup = $ionicPopup.alert({\n      title: title,\n      template: message\n    });\n  }\n\n  const getSpecificContentForWell = (resource) => {\n    const watertableHeight = resource.last_value;\n    return `\n    <br/>Depth to Water Table: ${saftelyGetLevelString(watertableHeight)} m\n    `\n  }\n\n    const getSpecificContentForCheckDam = (resource) => {\n      return `\n      <br/>Latest Reading: ${saftelyGetLevelString(resource.last_value)} m\n      `\n    }\n\n    const getSpecificContentForRainGauge = (resource) => {\n      return `\n      <br/>Latest Reading: ${saftelyGetLevelString(resource.last_value)} mm\n      `\n    }\n\n    function getPopupContentForResource(resource) {\n      let postcodeVillage = `${resource.postcode}:${resource.villageId}`;\n\n      if (!angular.isNullOrUndefined(resource.village)) {\n        villageName = resource.village.name;\n      }\n\n      let specificContent = null;\n      switch (resource.type) {\n        case ResourceType.WELL:\n          specificContent = getSpecificContentForWell(resource);\n          break;\n        case ResourceType.CHECKDAM:\n          specificContent = getSpecificContentForCheckDam(resource);\n          break;\n        case ResourceType.RAINGAUGE:\n          specificContent = getSpecificContentForRainGauge(resource);\n      }\n\n      return `<div style=\"line-height:1.35;overflow:hidden;white-space:nowrap;\"> Village: ${$scope.getVillageName(resource.postcode, resource.villageId)}\n      <br/>ResourceId : ${resource.id}\n      ${specificContent}\n      <br/><a class=\"button button-small popup-more-button\" href=#/tab/map/${resource.postcode}/${resource.id}>More</a>`;\n    }\n});\n","\"use strict\";\nangular.module('controller.map-detail', ['nvd3'])\n.controller('MapDetailController', function($scope, $state, $rootScope, ApiService, $stateParams, CachingService) {\n\n  $scope.$on('$ionicView.enter', function(e) {\n    return init()\n      .then(() => {\n        setupResourceType();\n        setupChart();\n      });\n  });\n\n  $scope.resourceId = $stateParams.resourceId;\n  $scope.stats = null;\n  let detailChart = null;\n  let allWeeklyReadings = [];\n  let splitWeeklyReadings = []; //all weekly readings split per year\n  let weeks = [];\n\n  let graphLabel = null;\n  let shouldReverseGraph = null;\n\n  const getReadingsByWeekMethod = (type) => {\n    switch (type) {\n      case 'raingauge':\n        return 'total';\n      default:\n        return 'average';\n    }\n  }\n\n  const setupResourceType = () => {\n    if (!$scope.resource) {\n      return null;\n    }\n\n    switch ($scope.resource.type) {\n      case 'well':\n        $scope.readableResourceType = \"Well\";\n        graphLabel = 'Depth to Water Level (m)';\n        shouldReverseGraph = true;\n        break;\n      case 'raingauge':\n        $scope.readableResourceType = \"Rainfall Station\";\n        graphLabel = \"Cumulative Weekly Rainfall Amount (mm)\";\n        shouldReverseGraph = false;\n        break;\n      case 'checkdam':\n        $scope.readableResourceType = \"Checkdam\";\n        graphLabel = \"Water Column Height (m)\"\n        shouldReverseGraph = false;\n        break;\n    }\n  }\n\n  const getChartDataAndLabel = (dataRange) => {\n    let dataAndLabel = {\n      data: [],\n      labels: null\n    };\n\n    switch (dataRange) {\n      case 'month':\n        dataAndLabel.data[0] = splitWeeklyReadings[0].slice(1).slice(-4);\n        dataAndLabel.data[1] = splitWeeklyReadings[1].slice(1).slice(-4);\n        dataAndLabel.data[2] = splitWeeklyReadings[2].slice(1).slice(-4);\n        dataAndLabel.labels = weeks.slice(-4).map(dateTime => moment(dateTime).format('DD-MMM'));\n        break;\n      case '3month':\n        dataAndLabel.data[0] = splitWeeklyReadings[0].slice(1).slice(-4 * 3);\n        dataAndLabel.data[1] = splitWeeklyReadings[1].slice(1).slice(-4 * 3);\n        dataAndLabel.data[2] = splitWeeklyReadings[2].slice(1).slice(-4 * 3);\n        dataAndLabel.labels = weeks.slice(-4 * 3).map(dateTime => moment(dateTime).format('DD-MMM'));\n        break;\n      case 'year':\n        dataAndLabel.data[0] = splitWeeklyReadings[0].slice(1).slice(-52);\n        dataAndLabel.data[1] = splitWeeklyReadings[1].slice(1).slice(-52);\n        dataAndLabel.data[2] = splitWeeklyReadings[2].slice(1).slice(-52);\n        dataAndLabel.labels = weeks.slice(-52).map(dateTime => moment(dateTime).format('DD-MMM'));\n        break;\n      default:\n        throw new Error(`dataRange ${dataRange} not found`);\n    }\n\n    return dataAndLabel;\n  }\n\n  const setupChart = () => {\n    const colors = [\n      {border:'rgba(54, 162, 235, 1)',background:'rgba(54, 162, 235, 0.2)'},\n      {border:'rgba(153, 102, 255, 1)', background:'rgba(153, 102, 255, 0.2)'},\n      {border:'rgba(255, 159, 64, 1)',background:'rgba(255, 159, 64, 0.2)'}\n    ]\n\n    let chartData = getChartDataAndLabel(\"month\");\n    const ctx = document.getElementById(\"detailChart\");\n    detailChart = new Chart(ctx, {\n      type: 'line',\n      data: {\n          labels: chartData.labels,\n          datasets: [\n          {\n            label: 'This year',\n            data: chartData.data[0],\n            borderWidth: 1,\n            backgroundColor: colors[0].background,\n            borderColor: colors[0].border,\n            fill: 'bottom'\n          },\n          {\n            label: 'Last Year',\n            data: chartData.data[1],\n            borderWidth: 1,\n            backgroundColor: colors[1].background,\n            borderColor: colors[1].border,\n            fill: 'bottom'\n          },\n          {\n            label: '2 years ago',\n            data: chartData.data[2],\n            borderWidth: 1,\n            backgroundColor: colors[2].background,\n            borderColor: colors[2].border,\n            fill: 'bottom'\n          }\n        ]\n      },\n      options: {\n        title: {\n            display: true,\n            text: graphLabel\n        },\n        spanGaps: false,\n        scales: {\n          yAxes: [{\n            ticks: {\n              beginAtZero:true,\n              reverse:shouldReverseGraph\n            }\n          }]\n        }\n      }\n    });\n  }\n\n  function init() {\n    return setupData();\n  }\n\n  $scope.updateData = (dataRange) => {\n    const chartData = getChartDataAndLabel(dataRange);\n\n    detailChart.data.datasets[0].data = chartData.data[0];\n    detailChart.data.datasets[1].data = chartData.data[1];\n    detailChart.data.datasets[2].data = chartData.data[2];\n    detailChart.data.labels = chartData.labels;\n    detailChart.update();\n  }\n\n  //Get the data from the api service\n  function setupData() {\n    $rootScope.$broadcast('loading:show');\n\n    return ApiService.getResource($stateParams.postcode, $scope.resourceId)\n    .then(response => {\n      CachingService.saveFavouriteLocation(response.geo.lat, response.geo.lng);\n\n      if (!angular.isNullOrUndefined(response)) {\n        $scope.resource = response;\n      }\n\n      return Promise.all([\n        ApiService.getReadingsByWeek($stateParams.postcode, $scope.resourceId, getReadingsByWeekMethod($scope.resource.type)),\n        null,\n        /* This method is tooooo slow*/\n        // ApiService.getDifferenceFromJune(null, 'individual', $scope.resourceId, $stateParams.postcode)\n          // .catch(err => console.log(err)),\n        ApiService.getCurrentVillageAverage($stateParams.postcode, $scope.resourceId)\n      ]);\n    })\n    .then(results => {\n      console.log(\"finished loading data\");\n      const readingsByWeek = results[0].data;\n      allWeeklyReadings = readingsByWeek.readings;\n      weeks = readingsByWeek.weeks;\n\n      let juneData = null;\n      if (!angular.isNullOrUndefined(results[1]) && !angular.isNullOrUndefined(results[1].data)) {\n        let pastReadingDate = new Date(results[1].data.pastReadingDate).toISOString().slice(0,10);\n        let difference = `${results[1].data.difference.toFixed(2)} m`;\n        juneData =  {\n          pastReadingDate: pastReadingDate,\n          difference: difference\n        };\n      }\n\n      let readingValue = null;\n      let percentageFull = null;\n      if ($scope.resource && !angular.isNullOrUndefined($scope.resource.last_value)) {\n        readingValue = $scope.resource.last_value.toFixed(2);\n        percentageFull = (($scope.resource.well_depth - $scope.resource.last_value) / $scope.resource.well_depth * 100).toFixed(0);\n      }\n\n      let villageAverageReading = null;\n      if (!angular.isNullOrUndefined(results[2]) && !angular.isNullOrUndefined(results[2].data)) {\n        villageAverageReading = results[2].data.avgReading.value;\n      }\n\n      if (!angular.isNullOrUndefined($scope.readingValue) ||\n          !angular.isNullOrUndefined(percentageFull) ||\n          !angular.isNullOrUndefined(villageAverageReading) ||\n          !angular.isNullOrUndefined(juneData)) {\n        $scope.stats = {\n          readingValue: readingValue,\n          percentageFull: percentageFull,\n          villageAverageReading: villageAverageReading,\n          juneData: juneData\n        }\n      }\n\n      //Split into 3, one for each year\n      const slicePoints = [0, 51, 103, allWeeklyReadings.length]\n      splitWeeklyReadings = [\n        allWeeklyReadings.slice(slicePoints[2], slicePoints[3]),//This year\n        allWeeklyReadings.slice(slicePoints[1], slicePoints[2]),\n        allWeeklyReadings.slice(slicePoints[0], slicePoints[1])\n      ];\n\n      $rootScope.$broadcast('loading:hide');\n    })\n    .catch(function(err) {\n      console.log('Error setting up data', err);\n      $rootScope.$broadcast('loading:hide');\n    });\n  }\n\n  function saftelyGetLevelString(value) {\n    if (angular.isNullOrUndefined(value)) {\n      return \"\";\n    }\n    return value.toFixed(2);\n  }\n})\n.filter('capitalize', function() {\n    return function(input) {\n      return (!!input) ? input.charAt(0).toUpperCase() + input.substr(1).toLowerCase() : '';\n    }\n});\n","angular.module('controller.register', [])\n.controller('RegisterController', ($scope, $location, $rootScope, $ionicModal, $ionicPopup, $ionicHistory, ApiService, CachingService, apiUrl) => {\n\n  let leafletMap = null;\n  $scope.resources = [\n    \"well\",\n    \"checkdam\",\n    \"raingauge\"\n  ];\n\n  $scope.refreshCoords = () => {\n    if (angular.isNullOrUndefined(leafletMap)) {\n      return;\n    }\n\n    const center = leafletMap.getCenter();\n    $scope.form.lat = null;\n    $scope.form.lng = null;\n\n    $scope.form.lat = center.lat;\n    $scope.form.lng = center.lng;\n  }\n\n  const init = function() {\n    //load an unsaved resource from localstorage if exists\n    $scope.form = CachingService.getResourceFromCache();\n\n    //fix up because data format isn't nice:\n    if (!angular.isNullOrUndefined($scope.form.elevation)) {\n      $scope.form.max_wt_depth = $scope.form.elevation;\n    }\n    if (!angular.isNullOrUndefined($scope.form.geo)) {\n      $scope.form.lat = $scope.form.geo.lat;\n      $scope.form.lng = $scope.form.geo.lng;\n    }\n\n    //Set up the Leaflet Map\n    if (angular.isNullOrUndefined(leafletMap)){\n      leafletMap = L.map('leafletMapRegister', { zoomControl:false, dragging: true, doubleClickZoom:false }).setView([24.593, 74.198], 17);\n      L.tileLayer('https://api.mapbox.com/styles/v1/lewisdaly/ciuqhjyzo00242iphq3wo7bm4/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibGV3aXNkYWx5IiwiYSI6ImNpdXE3ajltaDAwMGYyb2tkdjk2emx3NGsifQ.wnqFweA7kdijEtsgjTJIPw')\n       .addTo(leafletMap);\n     }\n  }\n  init();\n\n  $scope.locate = function() {\n    if (navigator.geolocation) {\n      navigator.geolocation.getCurrentPosition(function(position){\n        leafletMap.panTo(new L.LatLng(position.coords.latitude, position.coords.longitude));\n        $scope.form.lat = position.coords.latitude;\n        $scope.form.lng = position.coords.longitude;\n        $scope.$apply();\n\n        //TODO: drop pin\n      }, function(err) {\n        console.log(err);\n        var alertPopup = $ionicPopup.alert({\n          title: 'GeoLocation Error',\n          template: err.message\n        });\n      });\n    }\n    else {\n      console.log(\"Geolocation is not supported by this browser.\");\n      var alertPopup = $ionicPopup.alert({\n        title: 'GeoLocation Error',\n        template: \"Geolocation is not supported\"\n      });\n    }\n  }\n\n  /**\n   * Check the map to see if we have a valid lat and lng, if we do, move the map the correct place\n   */\n  const checkAndUpdateMap = () => {\n    if (angular.isNullOrUndefined($scope.form.lat) || angular.isNullOrUndefined($scope.form.lng)) {\n      return\n    }\n    if ($scope.form.lat.toString().length < 5 || $scope.form.lng.toString().length < 4) {\n      return;\n    }\n    //We have a valid(ish) lat and lng\n    leafletMap.panTo(new L.LatLng($scope.form.lat, $scope.form.lng));\n  }\n\n  $scope.$watch('form.lat', checkAndUpdateMap);\n  $scope.$watch('form.lng', checkAndUpdateMap);\n\n  $scope.submit = function(form) {\n    if (form === false) {\n      $scope.modal.hide();\n      return;\n    }\n\n    let isFormValid = true;\n\n    if ((form == null)\n        || (form.village_name == null) || (form.village_name.trim() === \"\")\n        || (form.owner == null)\n        || (form.postcode == null)\n        || (form.type == null)\n        || (form.lat == null)\n        || (form.lng == null)) {\n      isFormValid = false;\n    }\n\n    //More specific requirements\n    if (form.type === \"well\" && angular.isNullOrUndefined(form.max_wt_depth)) {\n      isFormValid = false;\n    }\n\n    if (!isFormValid) {\n      var alertPopup = $ionicPopup.alert({\n        title: 'Error',\n        template: \"Please fill out all the fields\"\n      });\n\n      return;\n    }\n\n    if ((form.id > 9999) || (form.id < 1000)) {\n      var alertPopup = $ionicPopup.alert({\n        title: 'Error',\n        template: \"Id must be between 1000-9999\"\n      });\n\n      return;\n    }\n\n    //For now, assume all villages are just 11\n    const villageId = 11;\n\n    const data = {\n      geo: {\n        lat: form.lat,\n        lng: form.lng\n      },\n      owner: form.owner,\n      village_name: form.village_name.trim(),\n      email: form.email,\n      well_depth: form.max_wt_depth,\n      type:form.type,\n      postcode: form.postcode,\n      villageId: villageId,\n      elevation: 0\n    };\n\n    ApiService.registerWell(data)\n    .then(function(response) {\n      var alertPopup = $ionicPopup.alert({\n        title: 'Thanks!',\n        template: `Created a new ${form.type} in ${form.village_name.trim()}`\n      });\n\n      //navigate back if possible\n      $ionicHistory && $ionicHistory.goBack();\n    })\n    .catch(function(err) {\n      if (err.status === 0) {\n        displayMessage(\"Connection Error\", \"Saving. Please try again later.\");\n        CachingService.addResourceToCache(data);\n        return;\n      }\n\n      console.log(\"err\", err);\n      var alertPopup = $ionicPopup.alert({\n        title: 'Error',\n        template: err.statusText\n      });\n    });\n  }\n\n\n\n})\n","'use strict';\nangular.module('report.controllers', [])\n\n.controller('ReportController', function($scope, $ionicPopup, $http, apiUrl, $rootScope, LoginService, ApiService, CachingService, Upload) {\n\n  /**\n   * Init\n   */\n\n  //Set up the form\n  resetForm();\n\n  $scope.$on('$ionicView.enter', function(e) {\n    checkUserStatus();\n    $scope.cachedReports = CachingService.getReportCache();\n  });\n\n  $scope.$on('login-state-changed', function(e) {\n    checkUserStatus();\n  })\n\n  $scope.refreshUser = function() {\n    //Perform login again - in case user's verification status has changed:\n    LoginService.reAuthenticateUser()\n    .then(function(response){\n      var currentUser = $rootScope.globals.currentUser;\n      console.log(\"currentUser: \" + JSON.stringify(currentUser));\n      checkUserStatus();\n\n    },function(error) {\n    });\n  }\n\n  const readingTypes = {\n    well: {\n      id: 'well',\n      name: 'Well',\n      valuePlaceholder: 'Depth to Water Level (m)'\n    },\n    raingauge: {\n      id: 'raingauge',\n      name: 'Rainfall',\n      valuePlaceholder: 'Rainfall amount (mm)'\n    },\n    checkdam: {\n      id: 'checkdam',\n      name: 'Checkdam',\n      valuePlaceholder: 'Water Column Height (m)'\n    }\n  }\n\n  $scope.readingType = readingTypes.well;\n  $scope.setReadingType = (readingType) => {\n    $scope.readingType = readingTypes[readingType];\n  }\n\n\n  function checkUserStatus() {\n    $scope.isUserNotLoggedIn = false;\n    $scope.isUserNotVerified = false;\n    $scope.isUserLoggedInAndVerified = false;\n\n    var currentUser = $rootScope.globals.currentUser;\n\n    if (!currentUser) {\n      $scope.isUserNotLoggedIn = true;\n    }\n    else if (currentUser.verified == false) {\n      $scope.isUserNotVerified = true;\n    }\n    else\n    {\n      $scope.isUserLoggedInAndVerified = true;\n    }\n  }\n\n  // Validate and submit form\n  $scope.sendReport = function(form){\n\n    // TODO: Validate fields\n    if (($scope.form.postcode == null) || ($scope.form.postcode == null) || ($scope.form.postcode== null) || ($scope.form.postcode == null))\n    {\n      console.log(\"Fill out the form!\");\n      var alertPopup = $ionicPopup.alert({\n        title: 'Error',\n        template: \"Please fill out all the fields\"\n      });\n    }\n    else\n    {\n      let data = {\n        postcode: $scope.form.postcode,\n        value: $scope.form.value,\n        resourceId: $scope.form.resourceId,\n        villageId: `${$scope.form.resourceId}`.substring(0,2),\n        date: $scope.form.date.toDateString()\n      }\n\n      ApiService.updateReading(data)\n      .then(function(response) {\n        displayMessage(\"Thanks!\", \"Submitted successfully.\")\n        resetForm();\n      })\n      .catch(function(err) {\n        if (err.status === 0) {\n          displayMessage(\"Connection Error\", \"Saving for later submission.\");\n          CachingService.addReportToCache(data);\n          $scope.cachedReports = CachingService.getReportCache();\n          resetForm();\n        } else {\n          console.log(\"Error: \", err);\n          displayMessage(\"Error\", err.data.error.message);\n        }\n      });\n    }\n  }\n\n  $scope.submit = function(index) {\n    let report = CachingService.getReportAtIndex(index);\n    ApiService.updateReading(report)\n    .then(function(response) {\n      console.log(\"Submitted successfully\", response);\n      displayMessage(\"Thanks!\", \"Submitted successfully.\")\n      CachingService.deleteReportAtIndex(index);\n      $scope.cachedReports = CachingService.getReportCache();\n\n    })\n    .catch(function(err) {\n      if (err.status === 0) {\n        displayMessage(\"Connection Error\", \"Still having trouble connecting. Please try again later.\");\n      } else {\n        console.log(\"Error: \", err);\n        displayMessage(\"Error\", err.data.error.message);\n      }\n    });\n  }\n\n  $scope.delete = function(index) {\n    CachingService.deleteReportAtIndex(index);\n    $scope.cachedReports = CachingService.getReportCache();\n  }\n\n  /**\n   *  Helper functions\n   */\n  function displayMessage(title, message) {\n    var alertPopup = $ionicPopup.alert({\n        title: title,\n        template: message\n      });\n  }\n\n  function resetForm () {\n    $scope.form = {};\n    $scope.form.date =  new Date();\n  }\n\n\n  /**\n   * File uploading\n   */\n  $scope.upload = function (file) {\n    //show loading indicator manually\n    $rootScope.$broadcast('loading:show');\n      Upload.upload({\n          url: `${apiUrl}/api/containers/container1/upload`,\n          data: {file: file }\n      }).then(function (resp) {\n          console.log('Success ' + resp.config.data.file.name + 'uploaded. Response: ' + resp.data);\n          return Promise.resolve(resp.data.result.files.file[0]);\n      }, function (resp) {\n          console.log('Error status: ' + resp.status);\n          throw new Error(resp);\n      }, function (evt) {\n          var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);\n          console.log('progress: ' + progressPercentage + '% ' + evt.config.data.file.name);\n      })\n      .then((fileResponse) => {\n        return ApiService.processExcelFile(fileResponse);\n      })\n      .then((res) => {\n        console.log(res);\n        displayMessage('Done', `Saved ${res.data.created} readings, with ${res.data.warnings.length} warnings`);\n      })\n      .catch(err => {\n        console.error('error', err);\n        if (err.status === 500) {\n          return displayMessage('Error', 'Could not process file. Please ensure the format is correct.');\n        }\n\n        displayMessage('Error', err.statusText);\n      });\n  };\n\n  $scope.clearFile = function() {\n    $scope.file = null;\n  }\n\n  $scope.submitFile = function() {\n    if ($scope.form.file.$valid && $scope.file) {\n      $scope.upload($scope.file);\n    }\n  };\n\n})\n","angular.module('controller.settings', [])\n.controller('SettingsController', function($scope, AuthenticationService, $location, $rootScope, $ionicModal, $ionicPopup, ApiService, CachingService, apiUrl, version_number) {\n  $scope.version_number = version_number;\n  $scope.templateUrl = `${apiUrl}/containers/container1/download/template`;\n  $scope.apiBaseUrl = apiUrl;\n  $scope.imageResourceId = null;\n\n  $scope.isDesktop = angular.isNullOrUndefined(window.cordova);\n\n\t$scope.$on('$ionicView.enter', function(e) {\n\t\tcheckUserStatus();\n\t});\n\n\t$scope.$on('login-state-changed', function(e) {\n  \t\tcheckUserStatus();\n\t\t});\n\n\t$scope.logout = function() {\n\t\tAuthenticationService.ClearCredentials();\n\t\t$rootScope.$broadcast('login-state-changed');\n\t\t$scope.isVerified = false;\n\t\t$scope.unverifiedUsers = [];\n\t}\n\n  //if the user is an admin, load the list of requesting users!\n\tfunction checkUserStatus() {\n\t\t$scope.unverifiedUsers = [];\n\t\t$scope.isUserNotLoggedIn = false;\n\t\t$scope.isUserNotVerified = false;\n\t\t$scope.isUserLoggedInAndVerified = false;\n\t\t$scope.isVerified = false;\n\n\t\tvar currentUser = $rootScope.globals.currentUser;\n\n    \tif (!currentUser) {\n\t\t\t$scope.isUserNotLoggedIn = true;\n\t\t\t}\n\t\telse if (currentUser.verified == false) {\n\t\t    $scope.isUserNotVerified = true;\n\t    }\n\t    else {\n\t    \t$scope.isUserLoggedInAndVerified = true;\n\t\t\t$scope.isVerified = true;\n\t\t\t// loadUnverifiedUsers();\n\t\t}\n\t}\n\n  /**\n   * Add new image for resource\n   */\n  $scope.showGetImagePopup = function() {\n    let shouldCloseSilently = false;\n    const isDataValid = (data) => {\n      let valid = true;\n\n      if (angular.isNullOrUndefined(data)) { valid = false; return false; }\n      if (angular.isNullOrUndefined(data.postcode)){ valid = false; return false; }\n      if (angular.isNullOrUndefined(data.imageResourceId)) { valid = false; return false; }\n\n      if (`${data.imageResourceId}`.length != 4) { valid = false; }\n      return valid;\n    }\n\n    $scope.data = {};\n\n    var popup = $ionicPopup.show({\n     template: '<div>\\\n       <input type=\"number\" placeholder=\"Pin Code\" ng-model=\"data.postcode\">\\\n       <input type=\"number\" placeholder=\"ResourceId\" ng-model=\"data.imageResourceId\">\\\n      </div>',\n     title: 'Details',\n     subTitle: 'Enter the details of the resource to attach the image to.',\n     scope: $scope,\n     buttons: [\n      {\n        text: 'Cancel',\n        onTap: function(e) {\n          shouldCloseSilently = true;\n        }\n      },\n      {\n        text: '<b>Next</b>',\n        type: 'button-positive',\n        onTap: function(e) {\n          if (!isDataValid($scope.data)) {\n           e.preventDefault();\n           console.log(\"Data is not valid, data\", $scope.data);\n          } else {\n           return $scope.data;\n          }\n         }\n       }\n     ]\n    });\n\n   popup\n    .then(response => {\n      if (angular.isNullOrUndefined(response)) {\n        //Do nothing!\n        return null;\n      }\n      const postcode = response.postcode;\n      const imageResourceId = response.imageResourceId;\n\n      return getImage()\n        .then(data => {\n          console.log('get image data', data);\n          return ApiService.uploadImageForResource(postcode, imageResourceId, data)\n        })\n    })\n    .then(() => {\n      if (!shouldCloseSilently) {\n        displayMessage('Thanks.', 'Updated image successfully!');\n      }\n    })\n    .catch(err => {\n      console.log('Error getting image', err);\n      displayMessage('Error updating image', err.statusText);\n    });\n }\n\n  const getImage = () => {\n    return new Promise((resolve, reject) => {\n      if (angular.isNullOrUndefined(navigator) || angular.isNullOrUndefined(navigator.camera)) {\n        displayMessage(\"Error\", \"The camera is not available on your device\");\n\n        //Right now for testing\n        return reject(new Error('Unsupported device'));\n      }\n\n      //TODO: tweak these settings\n      navigator.camera.getPicture(resolve, reject, {\n        quality: 10,\n        destinationType: Camera.DestinationType.DATA_URL,\n        targetWidth: 500,\n        targetHeight: 250,\n        // destinationType: Camera.DestinationType.FILE_URI\n        sourceType: Camera.PictureSourceType.CAMERA\n      });\n\n      //We need to read the image back, and then squash it!\n    });\n  }\n\n  const displayMessage = (title, message) => {\n    var alertPopup = $ionicPopup.alert({\n      title: title,\n      template: message\n    });\n  }\n\n});\n","angular.module('controller.signup',[])\n.controller('SignupController', function($scope, $location, SignupService, AuthenticationService, $window, debug) {\n\t$scope.user = {};\n\n\t$scope.signup = function() {\n    //TODO: Verify the email, passwords etc.\n    //TODO: fix: for some reason email is coming back null..\n    $window.location.reload(true);\n\n    //Always log in in debug mode!\n     if (debug == 1) {\n        AuthenticationService.SetCredentials(\"lewis\", 1, \"password\");\n        $location.path('/tab/map');\n        return;\n    }\n\n\n    SignupService.signUp($scope.user)\n    .then(function(data) {\n    \tconsole.log(\"Controller success: \" + data);\n\n        //Now log in the new user\n        AuthenticationService.Login($scope.user)\n        .then(function(response) {\n            //Get the logged in user info\n            AuthenticationService.getCredentials()\n            .then(function(credentialsData) {\n                AuthenticationService.SetCredentials($scope.user.username, credentialsData.data.userID, $scope.user.password);\n                $location.path('/tab/map');\n            },\n            function(data) {\n                console.log(\"Error getting user info\");\n            });\n        },\n        function(data) {\n            console.log(\"Login Error\");\n        });\n    },\n    function(data) {\n    \tconsole.log(\"contorller Error\");\n    })\n  }\n});\n","\"use strict\";\nangular.module('controller.village-detail', ['nvd3'])\n.controller('VillageDetailController', function($scope, $state, ApiService, $stateParams) {\n\n  $scope.$on('$ionicView.enter', function(e) {\n\n  });\n\n  $scope.villageId = $stateParams.villageId;\n\n  //Get the data from the api service\n  // ApiService.getStatisticsForResource($stateParams.postcode, $scope.villageId)\n  // .then(data => {\n  //\n  //   //TODO: if resourceId is 2 digits, it is a village, if 4 then a resource\n  //\n  //   const emptyAverage = {last_value:0}\n  //   let resource = emptyAverage;\n  //   let villageAverage = emptyAverage;\n  //\n  //   if (!angular.isNullOrUndefined(data[0])) {\n  //     resource = data[0].data;\n  //   }\n  //\n  //   if (!angular.isNullOrUndefined(data[1])) {\n  //     villageAverage = data[1].data;\n  //   }\n  //\n  //   let historicalResourceAverages = data[2].data.readings;\n  //   let historicalVillageAverages = data[3].data.readings;\n  //\n  //   $scope.resource = resource;\n  //   $scope.village = villageAverage;\n  //\n  //   //Calculate the % full\n  //   const percentageFull = (((resource.well_depth - resource.last_value)/resource.well_depth) * 100).toFixed(2);\n  //   $scope.resource.percentageFull = percentageFull;\n  //   const watertableHeight = resource.well_depth - resource.last_value;\n  //   $scope.watertableHeight = watertableHeight;\n  //\n  //\n  //   //Add the current village and resource readings to the historical:\n  //   const thisMonthString = new Date().toISOString().slice(0,7);\n  //   historicalResourceAverages.push({month:thisMonthString, aveReading:resource.last_value});\n  //   historicalVillageAverages.push({month:thisMonthString, aveReading:villageAverage.last_value});\n  //\n  //   console.log(resource);\n  //\n  //   //Convert to the right format for d3\n  //   $scope.data.push(mapHistoricalDataToD3(historicalResourceAverages, 'Well Average', '#1f77b4'));\n  //   $scope.data.push(mapHistoricalDataToD3(historicalVillageAverages, 'Village Average', '#d62728'));\n  // })\n  // .catch(function(err) {\n  //   console.log(err);\n  //\n  // });\n\n  // $scope.options = {\n  //   chart: {\n  //     type: 'multiBarChart',\n  //     height: 450,\n  //     margin: {\n  //       top: 20,\n  //       right: 20,\n  //       bottom: 100,\n  //       left: 55\n  //     },\n  //     x: function(d) {\n  //       return d.label;\n  //     },\n  //     y: function(d) {\n  //       return 0 - d.value;\n  //     },\n  //     showValues: false,\n  //     showControls: false,\n  //     valueFormat: function(d) {\n  //       return d3.format(',.4f')(d);\n  //     },\n  //     duration: 500,\n  //     xAxis: {\n  //       axisLabel: 'Month',\n  //       rotateLabels: 30\n  //     },\n  //     yAxis: {\n  //       axisLabel: 'Depth to water level (m)',\n  //       axisLabelDistance: -10,\n  //       tickFormat: function(d) {\n  //         return (-d);\n  //       }\n  //     },\n  //     tooltip: {\n  //       enabled: false\n  //     },\n  //   }\n  // };\n  //\n  // $scope.data = [\n  //   // {\n  //   //   \"key\" : \"aveValueVillage\",\n  //   //   \"bar\": true,\n  //   //   \"color\": \"#d62728\",\n  //   //   \"values\": [\n  //   //     {label:'2015-01', value:0.45},\n  //   //     {label:'2015-02', value:1},\n  //   //     {label:'2015-03', value:0.22},\n  //   //     {label:'2015-04', value:0.12},\n  //   //     {label:'2015-05', value:0.4},\n  //   //     {label:'2015-06', value:0.5},\n  //   //     {label:'2015-07', value:0.9},\n  //   //     {label:'2015-08', value:0.1},\n  //   //     {label:'2015-09', value:0.1},\n  //   //     {label:'2015-10', value:0.1},\n  //   //     {label:'2015-11', value:0.1},\n  //   //     {label:'2015-12', value:0.1}\n  //   //   ]\n  //   // },\n  //   // {\n  //   //   \"key\" : \"aveValueWell\",\n  //   //   \"bar\": true,\n  //   //   \"color\": \"#1f77b4\",\n  //   //   \"values\": [\n  //   //     {label:'2015-01', value:0.1},\n  //   //     {label:'2015-02', value:0.5},\n  //   //     {label:'2015-03', value:0.12},\n  //   //     {label:'2015-04', value:0.2},\n  //   //     {label:'2015-05', value:0.6},\n  //   //     {label:'2015-06', value:0.7},\n  //   //     {label:'2015-07', value:0.7},\n  //   //     {label:'2015-08', value:0.4},\n  //   //     {label:'2015-09', value:0.1},\n  //   //     {label:'2015-10', value:0.4},\n  //   //     {label:'2015-11', value:0.3},\n  //   //     {label:'2015-12', value:0.2}\n  //   //   ]\n  //   // }\n  // ];\n  //\n  //\n  // function mapHistoricalDataToD3(historicalData, graphKey, color) {\n  //   //We have an array containing months: [{aveReading:x, month:\"YYYY-MM\"}, ...]\n  //   const values = historicalData.map(value => {\n  //     return {label: value.month, value: value.aveReading};\n  //   });\n  //   return {\n  //     key: graphKey,\n  //     bar:true,\n  //     color: color,\n  //     values: values\n  //   };\n  // }\n});\n","'use strict';\n\nangular.module('service.api', [])\n.service('ApiService', function($http, $q, $rootScope, apiUrl, AuthenticationService, $localstorage, CachingService) {\n\n  return({\n    getResources:getResources,\n    getVillages:getVillages,\n    getClosestVillage:getClosestVillage,\n    registerWell:registerWell,\n    updateReading:updateReading,\n    login:login,\n    getStatisticsForResource: getStatisticsForResource,\n    processExcelFile: processExcelFile,\n    getDifferenceFromJune: getDifferenceFromJune,\n    getResourceReadings: getResourceReadings,\n    getResource: getResource,\n    uploadImageForResource: uploadImageForResource,\n    getReadingsByWeek: getReadingsByWeek,\n    getCurrentVillageAverage: getCurrentVillageAverage,\n    sendLoginCodeSMS: sendLoginCodeSMS,\n    sendLoginCodeEmail: sendLoginCodeEmail,\n    loginWithCode: loginWithCode,\n    isLoggedIn:isLoggedIn\n  });\n\n\n  function uploadImageForResource(postcode, resourceId, data) {\n    return $http({\n      method:'post',\n      headers: {'Content-Type':'application/json'},\n      url: `${apiUrl}/api/resources/updateResourceByIdAndPostcode?access_token=${AuthenticationService.getAccessToken()}`,\n      data: {\n        image: data,\n        postcode: postcode,\n        id: resourceId\n      }\n    });\n  }\n\n  function getResource(postcode, resourceId) {\n    const query = {\"where\":{\"and\":[{\"postcode\":postcode}, {\"id\":resourceId}]}}\n    const url = `${apiUrl}/api/resources?filter=${encodeURIComponent(JSON.stringify(query))}`;\n\n    return $http({\n      method:'get',\n      headers: {'Content-Type':'application/json'},\n      url: url,\n    }).then(response => response.data[0]);\n  }\n\n  function getReadingsByWeek(postcode, resourceId, method) {\n    return $http({\n      method: 'get',\n      headers: {'Content-Type':'application/json'},\n      url: `${apiUrl}/api/readings/readingsByWeek?postcode=${postcode}&resourceId=${resourceId}&method=${method}`\n    });\n  }\n\n  function getResourceReadings(postcode, resourceId) {\n    //TODO: optimize this later on to only get the past year...\n    const requestUrl = `/api/readings?filter=%7B%22where%22%3A%7B%22and%22%3A%5B%7B%22postcode%22%3A${postcode}%7D%2C%7B%22resourceId%22%3A${resourceId}%7D%5D%7D%2C%20%22order%22%3A%20%22date%20ASC%22%7D&access_token=${AuthenticationService.getAccessToken()}`\n\n    return $http({\n      method: 'get',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + requestUrl\n    });\n  }\n\n  /**\n   * Get all the villages, with their\n   */\n  function getDifferenceFromJune(resourceType, readingType, resourceId, postcode) {\n    let requestUrl = `/api/resource_stats/getDifferenceFromJune?readingType=${readingType}&resourceId=${resourceId}&postcode=${postcode}`\n    if (!angular.isNullOrUndefined(resourceType)) {\n      requestUrl = requestUrl + `&resourceType={$resourceType}`\n    }\n\n    return $http({\n      method:'get',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + requestUrl\n    });\n  }\n\n  function getVillages() {\n    return Promise.resolve(true)\n    .then(() => showLoadingIndicator())\n    .then(() => {\n      return $http({\n        method:'get',\n        headers: {'Content-Type':'application/json'},\n        url: apiUrl + '/api/villages'\n      });\n    })\n    .then(response => {\n      hideLoadingIndicator()\n      return response.data;\n    })\n    .catch(err => {\n      hideLoadingIndicator()\n      return Promise.reject(err)\n    })\n  }\n\n  //Load all of the things\n  //fallback to cache if fails\n  function getResources() {\n    return $http({\n      method:'get',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + '/api/resources?filter=%7B%22fields%22%3A%7B%22image%22%3Afalse%7D%7D'\n    })\n    .then(function(response) {\n      //cache the response\n      $localstorage.setObject('getResourcesCache', response);\n      return response;\n    })\n    .catch(function(err) {\n      //Rollback to previous request if exists\n      let cached = $localstorage.getObject('getResourcesCache');\n      if (!angular.isNullOrUndefined(cached)) {\n        return cached;\n      }\n\n      return Promise.reject(err);\n    });\n  }\n\n  function getClosestVillage(villageId) {\n    return $http({\n      method:'get',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + '/api/villages/closestVillage?villageId=' + villageId\n    });\n  }\n\n  /**\n   * Update a resource reading\n   * If we cannot connect, save to localstorage array\n   */\n  function updateReading(reading) {\n    return Promise.resolve(true)\n      .then(() => showLoadingIndicator())\n      .then(() => $http({\n          method:'post',\n          headers: {'Content-Type':'application/json'},\n          url: apiUrl + '/api/readings/saveOrCreate?access_token=' + AuthenticationService.getAccessToken(),\n          data:reading,\n        })\n      )\n      .then(res => {\n        hideLoadingIndicator();\n        return res;\n      })\n      .catch((err) => {\n        hideLoadingIndicator();\n        return Promise.reject(err);\n      })\n  }\n\n  function registerWell(resource) {\n    return $http({\n      method:'post',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + '/api/resources?access_token=' + AuthenticationService.getAccessToken(),\n      data:resource\n    });\n  }\n\n  //simple login\n  // function login(password) {\n  //   return $http({\n  //     method:'get',\n  //     headers: {'Content-Type':'application/json'},\n  //     url: apiUrl + '/api/users/login?password=' + password\n  //   });\n  // }\n\n  function login(username, password) {\n    return $http({\n      method:'post',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + '/api/Users/login',\n      data: {username:username, password:password}\n    });\n  }\n\n  /**\n   * Check if token is valid, if no token is set, defaults to Auth service's token\n   */\n  function isLoggedIn(optional_token) {\n    if (!optional_token) {\n      optional_token = AuthenticationService.getAccessToken();\n    }\n\n    return $http({\n      method: 'get',\n      headers: {'Content-Type':'application/json'},\n      url: `${apiUrl}/api/Clients/isLoggedIn?access_token=${optional_token}`\n    });\n  }\n\n  function getCurrentVillageAverage(postcode, resourceId) {\n    const villageId = resourceId.substring(0,2);\n\n    return $http({\n      method:'get',\n      headers: {'Content-Type':'application/json'},\n      url: `${apiUrl}/api/resource_stats/getCurrentVillageAverage?villageId=${villageId}&postcode=${postcode}`,\n    }).catch(err => {\n      if (err.status !== 404) return Promise.reject(err);\n      console.log(\"No current village reading\");\n    });\n  }\n\n\n  /**\n   * Get the info and statistics for a resource\n   * @returns Promise<[resource, villageAverage, historicalResourceAverages, historicalVillageAverages ]\n   */\n  function getStatisticsForResource(postcode, resourceId) {\n    //Get all of the needed statistics:\n    const villageId = resourceId.substring(0,2);\n\n    const skip404Error = (err) => {\n      console.log(\"err\", err);\n      if (err.status !== 404) return Promise.reject(err);\n    }\n\n    return Promise.all([\n      $http({\n        method:'get',\n        headers: {'Content-Type':'application/json'},\n        url: `${apiUrl}/api/resources/${resourceId}&postcode=${postcode}`,\n      }).catch(err => skip404Error(err)),\n      $http({\n        method:'get',\n        headers: {'Content-Type':'application/json'},\n        url: `${apiUrl}/api/resource_stats/getCurrentVillageAverage?villageId=${villageId}&postcode=${postcode}`,\n      }).catch(err => skip404Error(err)),\n      $http({\n        method:'get',\n        headers: {'Content-Type':'application/json'},\n        url: `${apiUrl}/api/resource_stats/getHistoricalResourceAverages?resourceId=${resourceId}&postcode=${postcode}`,\n      }).catch(err => skip404Error(err)),\n      $http({\n        method:'get',\n        headers: {'Content-Type':'application/json'},\n        url: `${apiUrl}/api/resource_stats/getHistoricalVillageAverages?villageId=${villageId}&postcode=${postcode}`,\n      }).catch(err => skip404Error(err))\n    ]);\n  }\n\n  function processExcelFile(fileResponse) {\n    //TODO: make url parameters load properly\n    //TODO: inject hide and show loading indicator into every request...\n    return Promise.resolve(true)\n      .then(() => showSlowLoadingIndicator())\n      .then(() => $http({\n                  method:'get',\n                  headers: {'Content-Type':'application/json'},\n                  url: `${apiUrl}/api/readings/processExcelFile?container=${fileResponse.container}&name=${fileResponse.name}&access_token=${AuthenticationService.getAccessToken()}`,\n                  timeout: 1000 * 60 * 10,// * 60 * 6 //6 mins\n                  headers: {\n                    'timeout': 1000,\n                    'Connection': 'Keep-Alive'\n                  }\n                }))\n      .then(res => {\n        hideLoadingIndicator();\n        return res;\n      })\n      .catch((err) => {\n        hideLoadingIndicator();\n        return Promise.reject(err);\n      })\n  }\n\n  function sendLoginCodeSMS(mobile_number) {\n    return $http({\n      method:'post',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + '/api/LoginCodes/sendSMSCode',\n      data: {mobile_number:mobile_number}\n    });\n  }\n\n  function sendLoginCodeEmail(email) {\n    return $http({\n      method:'post',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + '/api/LoginCodes/sendEmailCode',\n      data: {email:email}\n    });\n  }\n\n  function loginWithCode(mobile_number, email, code) {\n    let data = null;\n    if (mobile_number && !email) {\n      data = {mobile_number:mobile_number, code:code}\n    } else if (!mobile_number && email) {\n      data = {email:email, code:code}\n    } else {\n      return Promise.reject(new Error('Cannot set both mobile_number and email'));\n    }\n\n    return $http({\n      method:'post',\n      headers: {'Content-Type':'application/json'},\n      url: apiUrl + '/api/Clients/loginWithCode',\n      data: data\n    });\n  }\n\n  function showLoadingIndicator() {\n     $rootScope.$broadcast('loading:show');\n  }\n\n  function showSlowLoadingIndicator() {\n     $rootScope.$broadcast('loading:show-slow');\n  }\n\n\n  function hideLoadingIndicator() {\n     $rootScope.$broadcast('loading:hide');\n  }\n\n});\n","//Inspired by: http://jasonwatmore.com/post/2015/03/10/AngularJS-User-Registration-and-Login-Example.aspx\n(function () {\n    'use strict';\n    angular.module('service.authentication',[])\n    .factory('AuthenticationService', function($http, apiUrl, $rootScope, $timeout, $location, $localstorage, UserService){\n\n        var service = {};\n\n        service.Login = Login;\n        service.getCredentials = getCredentials;\n        service.SetCredentials = SetCredentials;\n        service.ClearCredentials = ClearCredentials;\n        service.getAccessToken = getAccessToken;\n        service.Logout = Logout;\n        service.tryLastTokenLogin = tryLastTokenLogin;\n\n        return service;\n\n        function Login(user) {\n            //This isn't ideal, just the way that this was structured.\n            return LoginService.login(user);\n        }\n\n        function Logout() {\n            // loginService.logout(); //TODO: fix, right now this doesn't work. But clearing credentials works for now.\n            ClearCredentials()\n        }\n\n        function getCredentials() {\n            return UserService.getUserDetails()\n        }\n\n        function getAccessToken() {\n          return $rootScope.globals.currentUser.authToken;\n        }\n\n        function tryLastTokenLogin() {\n          //get the token and try the endpoint\n          const lastUser = $localstorage.getObject('last_user', null);\n          if (!lastUser || !lastUser.currentUser) {\n            console.log(\"No last user found\");\n            return Promise.reject('No last user');\n          }\n\n          return $http({\n            method: 'get',\n            headers: {'Content-Type':'application/json'},\n            url: `${apiUrl}/api/Clients/isLoggedIn?access_token=${lastUser.currentUser.authToken}`\n          })\n          .then(() => {\n            SetCredentials(lastUser, lastUser.currentUser.authToken);\n          })\n          .catch(err => {\n            if (err.statusCode === 401) {\n              $localstorage.delete('last_user');\n            }\n          });\n        }\n\n\n        function SetCredentials(user, authToken) {\n            $rootScope.globals = {\n                currentUser: {\n                    userID:user.id,\n                    authToken: authToken,\n                    username: user.user_name,\n                    verified: user.verified,\n                    service: user.service\n                }\n            };\n\n            $localstorage.setObject('globals', $rootScope.globals);\n        }\n\n        function ClearCredentials() {\n            console.log(\"Clearing Credentials\");\n\n            //Save the user to try and login again if possible\n            const globals = $localstorage.getObject('globals', null);\n            if (globals && globals.currentUser && globals.currentUser.authToken) {\n              $localstorage.setObject('last_user', globals);\n            }\n\n            $rootScope.globals = {};\n            $localstorage.delete('globals');\n            $http.defaults.headers.common.Authorization = 'Basic';\n        }\n    })\n\n// Base64 encoding service used by AuthenticationService\nvar Base64 = {\n\n    keyStr: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=',\n\n    encode: function (input) {\n        var output = \"\";\n        var chr1, chr2, chr3 = \"\";\n        var enc1, enc2, enc3, enc4 = \"\";\n        var i = 0;\n\n        do {\n            chr1 = input.charCodeAt(i++);\n            chr2 = input.charCodeAt(i++);\n            chr3 = input.charCodeAt(i++);\n\n            enc1 = chr1 >> 2;\n            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\n            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\n            enc4 = chr3 & 63;\n\n            if (isNaN(chr2)) {\n                enc3 = enc4 = 64;\n            } else if (isNaN(chr3)) {\n                enc4 = 64;\n            }\n\n            output = output +\n            this.keyStr.charAt(enc1) +\n            this.keyStr.charAt(enc2) +\n            this.keyStr.charAt(enc3) +\n            this.keyStr.charAt(enc4);\n            chr1 = chr2 = chr3 = \"\";\n            enc1 = enc2 = enc3 = enc4 = \"\";\n        } while (i < input.length);\n\n        return output;\n    },\n\n    decode: function (input) {\n        var output = \"\";\n        var chr1, chr2, chr3 = \"\";\n        var enc1, enc2, enc3, enc4 = \"\";\n        var i = 0;\n\n            // remove all characters that are not A-Z, a-z, 0-9, +, /, or =\n            var base64test = /[^A-Za-z0-9\\+\\/\\=]/g;\n            if (base64test.exec(input)) {\n                window.alert(\"There were invalid base64 characters in the input text.\\n\" +\n                    \"Valid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\\n\" +\n                    \"Expect errors in decoding.\");\n            }\n            input = input.replace(/[^A-Za-z0-9\\+\\/\\=]/g, \"\");\n\n            do {\n                enc1 = this.keyStr.indexOf(input.charAt(i++));\n                enc2 = this.keyStr.indexOf(input.charAt(i++));\n                enc3 = this.keyStr.indexOf(input.charAt(i++));\n                enc4 = this.keyStr.indexOf(input.charAt(i++));\n\n                chr1 = (enc1 << 2) | (enc2 >> 4);\n                chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);\n                chr3 = ((enc3 & 3) << 6) | enc4;\n\n                output = output + String.fromCharCode(chr1);\n\n                if (enc3 != 64) {\n                    output = output + String.fromCharCode(chr2);\n                }\n                if (enc4 != 64) {\n                    output = output + String.fromCharCode(chr3);\n                }\n\n                chr1 = chr2 = chr3 = \"\";\n                enc1 = enc2 = enc3 = enc4 = \"\";\n\n            } while (i < input.length);\n\n            return output;\n        }\n    };\n\n\n})();\n","angular.module('service.login', [])\n\n.service(\"LoginService\",['$http', '$q', 'apiUrl', 'AuthenticationService', '$rootScope', function($http, $q, apiUrl, AuthenticationService, $rootScope) {\n  //TODO: figure out how to save user's login credentials, and auto login\n\n  //Return public api\n  return({\n    login: login,\n    logout: logout,\n    reAuthenticateUser: reAuthenticateUser\n  });\n\n  function reAuthenticateUser() {\n    return $q(function(resolve, reject){\n      //Get the current user\n      var currentUser = $rootScope.globals.currentUser;\n      if (!currentUser) {\n        reject(\"User is not logged in\");\n      } else {\n        //Perform the new login:\n        login(currentUser.service, currentUser.authToken)\n        .then(function(response) {\n          resolve(response);\n        }, function(error) {\n          reject(\"Error\");\n        })\n      }\n    })\n  }\n\n  //Send empty token if login isn't resuming\n  function login(service, token) {\n    return $q(function(resolve, reject) {\n\n      showLoadingIncicator();\n      switch(service) {\n        case 'facebook':\n        Azureservice.login(\"facebook\", token)\n        .then(function(results) {\n          var  currentUser = Azureservice.getCurrentUser();\n          console.log(\"Current user: \" + JSON.stringify(currentUser));\n\n          Azureservice.invokeApi(\"authenticateuser\", {\n            body: {\"service\":\"facebook\", \"user\":Azureservice.getCurrentUser()},\n            method: \"post\"})\n          .then(function(response) {\n            console.log(\"Azure success: \" + JSON.stringify(response));\n\n            // Store the authenticated user!\n            AuthenticationService.SetCredentials(response, currentUser.mobileServiceAuthenticationToken);\n            resolve(\"Success\");\n          },\n          function(err) {\n            console.error('Azure Error: ' + err);\n            hideLoadingIndicator();\n            reject(\"Error\")\n          });\n\n        }, function(error){\n          hideLoadingIndicator();\n          alert(error);\n          reject(\"Error\")\n\n        });\n\n        break;\n        case 'twitter':\n        Azureservice.login(\"twitter\", token)\n        .then(function(results) {\n          var  currentUser = Azureservice.getCurrentUser();\n          console.log(\"Current user: \" + JSON.stringify(currentUser));\n\n          Azureservice.invokeApi(\"authenticateuser\", {\n            body: {\"service\":\"twitter\", \"user\":Azureservice.getCurrentUser()},\n            method: \"post\"})\n          .then(function(response) {\n            console.log(\"Azure success: \" + JSON.stringify(response));\n\n            // Store the authenticated user!\n            AuthenticationService.SetCredentials(response, currentUser.mobileServiceAuthenticationToken);\n            resolve(\"Success\");\n          },\n          function(err) {\n            hideLoadingIndicator();\n            console.error('Azure Error: ' + err);\n            reject(\"Error\")\n          });\n\n        }, function(error){\n          hideLoadingIndicator();\n          alert(error);\n          reject(\"Error\")\n\n        });\n\n\n        break;\n        default:\n          //Google\n          Azureservice.login(\"google\", token)\n          .then(function(results) {\n            var  currentUser = Azureservice.getCurrentUser();\n            console.log(\"Current user: \" + JSON.stringify(currentUser));\n\n            Azureservice.invokeApi(\"authenticateuser\", {\n              body: {\"service\":\"google\", \"user\":Azureservice.getCurrentUser()},\n              method: \"post\"})\n            .then(function(response) {\n              console.log(\"Azure success: \" + JSON.stringify(response));\n\n              // Store the authenticated user!\n              AuthenticationService.SetCredentials(response, currentUser.mobileServiceAuthenticationToken);\n              resolve(\"Success\");\n            },\n            function(err) {\n              hideLoadingIndicator();\n              console.error('Azure Error: ' + err);\n              reject(\"Error\")\n            });\n\n          }, function(error){\n            hideLoadingIndicator();\n            alert(error);\n            reject(\"Error\")\n\n          });\n        }\n      });\n}\n\nfunction logout() {\n  var baseUrl = apiUrl;\n  var request = $http({\n    method: \"post\",\n    url: baseUrl + \"/logout\"\n  });\n  return (request.then(handleSuccess, handleError));\n}\n\n  //Private Methods\n  function handleError(response) {\n    if(!angular.isObject(response.data) || !response.data.message) {\n      return ($q.reject(\"An Unknown error occoured\"));\n    }\n\n    //Otherwise, error message:\n    return($q.reject(response.data.message));\n  }\n\n  function handleSuccess(response) {\n    return(response.data);\n  }\n\n  function showLoadingIncicator() {\n     $rootScope.$broadcast('loading:show');\n  }\n\n  function hideLoadingIndicator() {\n     $rootScope.$broadcast('loading:hide');\n  }\n}]);\n","angular.module('service.signup',[])\n//Influenced by: http://www.bennadel.com/blog/2612-using-the-http-service-in-angularjs-to-make-ajax-requests.htm\n.service(\"SignupService\", function($http, $q, apiUrl) {\n\n  //Return public api\n  return({\n    signUp: signUp //Sign up with a user object\n  });\n\n  //Public Methods\n\n  function signUp(user) {\n    var baseUrl = apiUrl;\n    var method = 'post';\n\n    if (constants.offline) {\n      method = \"get\"; //We need to send get request in offline mode\n    }\n\n    //TODO: We need to hash out the password\n    return $http({\n      method: method,\n      headers: {'Content-Type': 'application/json'},\n      url: baseUrl + \"/signup\", //TODO: make \n      data: user\n    }).success(function(data) {\n      console.log(\"Success\");\n    })\n    .error (function() {\n      console.log(\"Error\");\n    });\n  }\n});","angular.module('service.user', [])\n.service('UserService', function($http, $q, $rootScope, apiUrl) {\n\n\treturn({\n\t\tgetUser: getUser,\n\t\tgetUserDetails: getUserDetails,\n\t\tgetCurrentUserID: getCurrentUserID\n\t});\n\n\n\t//Gets any user\n\tfunction getUser(userID) {\n\t\t//If we haven't specified a user, return the current user\n\t\tif (!userID || userID === -1){userID = getCurrentUserID();}\n\n\n\t\tvar baseUrl = apiUrl;\n\n\t\treturn $http({\n\t\t\tmethod: \"get\",\n\t\t\theaders: {'Content-Type': 'application/json'},\n\t      \turl: baseUrl + \"/api/user/\" + userID\n\t\t})\n\t\t.success(function(data) {\n\n\t\t})\n\t\t.error(function() {\n\n\t\t});\n\t}\n\n\t//Gets the details for the current logged in user\n\tfunction getUserDetails() {\n\t\tvar baseUrl = apiUrl;\n\n\t\treturn $http({\n\t\t\tmethod: \"get\",\n\t\t\turl: baseUrl + \"/api/user/current\"\n\t\t})\n\t}\n\n\t//Private Methods\n\tfunction getCurrentUserID() {\n\t\tvar currentUser = $rootScope.globals.currentUser;\n\t\treturn currentUser.userID;\n\t}\n});\n"]}